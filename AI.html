<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OAP AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #212121;
      --bg-sidebar: #181818;
      --bg-card: #303030;
      --bg-input: #303030;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #3f3f46;
      --accent: #10b981;
      --accent-soft: rgba(16, 185, 129, 0.1);
      --msg-user-bg: #303030;
    }

    /* Ø«ÙŠÙ… ÙØ§ØªØ­ Ø¨Ø£Ù„ÙˆØ§Ù†Ùƒ */
    body.theme-light {
      --bg-main: #E6E3DF;     /* Ù„ÙˆÙ† Ø§Ù„ØµÙØ­Ø© */
      --bg-sidebar: #CCC8C6;  /* Ù„ÙˆÙ† Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
      --bg-card: #F6F5F4;     /* Ù„ÙˆÙ† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„ */
      --bg-input: #F6F5F4;    /* ÙŠØ·Ø§Ø¨Ù‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„ */
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: #d1d5db;
      --accent: #10b981;
      --accent-soft: rgba(16, 185, 129, 0.15);
      --msg-user-bg: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
    }

    .shell {
      display: flex;
      min-height: 100vh;
      width: 100%;
      position: relative;
    }

    /* Keep sidebar on the left even when language is Arabic (RTL) */
    body[dir="rtl"] .shell {
      direction: ltr;
    }

    /* ===== Sidebar (left) ===== */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      border-right: none;
      padding: 10px 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.2s ease-out;
      z-index: 30;
      box-shadow: none;
      position: relative;
    }

    .sidebar {
      scrollbar-width: none; /* Firefox */
    }

    .sidebar::-webkit-scrollbar {
      width: 0px;  /* Chrome/Safari */
      height: 0px;
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }


    body.theme-light .sidebar {
      box-shadow: none;
    }

    .shell.sidebar-collapsed .sidebar {
      transform: translateX(-260px);
      position: absolute;
      left: -260px;
      top: 0;
      bottom: 0;
      box-shadow: none;
    }

    .sidebar-toggle-close {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 40;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    body.theme-light .sidebar-toggle-close {
      background: transparent;
      color: #111827;
      border: none;
    }

    .shell.sidebar-collapsed .sidebar-toggle-close {
      display: none;
    }

    .sidebar-toggle-close:hover {
      background: transparent;
    }

    body.theme-light .sidebar-toggle-close:hover {
      background: transparent;
    }

    .brand-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 4px 10px;
      color: var(--text-main);
      font-size: 13px;
    }

    .brand-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    .brand-title {
      display: none;
    }

    .new-chat-btn {
      margin: 6px 6px 2px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-main);
      padding: 7px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .new-chat-btn span.icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .new-chat-btn span.icon::before {
      content: "ğŸ’¬";
      font-size: 13px;
    }

    .new-chat-btn:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    body.theme-light .new-chat-btn:hover {
      background: rgba(15, 23, 42, 0.04);
    }

    .nav-section-title {
      margin-top: 6px;
      margin-bottom: 4px;
      padding-inline: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-left: 4px;
      padding-right: 0;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(39, 39, 47, 0.6) transparent;
      flex: 1;
      max-height: calc(100vh - 200px);
    }

    .nav-list::-webkit-scrollbar {
      width: 6px;
    }
    .nav-list::-webkit-scrollbar-thumb {
      background: rgba(39, 39, 47, 0.6);
      border-radius: 999px;
    }
    .nav-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    body.theme-light .nav-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .nav-item {
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
      background: transparent;
      color: var(--text-main);
      cursor: pointer;
      position: relative;
    }

    .nav-item .icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #27272f;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    body.theme-light .nav-item .icon {
      background: #d1d5db;
      color: #111827;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.04);
      border: none;
    }

    body.theme-light .nav-item:hover {
      background: rgba(15, 23, 42, 0.04);
      border: none;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.06);
      border: none;
    }

    body.theme-light .nav-item.active {
      background: rgba(15, 23, 42, 0.06);
      border: none;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-inline: 8px;
      padding-top: 6px;
      border-top: 1px solid #000;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    body.theme-light .sidebar-footer {
      border-top-color: #d1d5db;
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    /* ===== PATCH: green user avatar ===== */
    ^px;
      height: 20px;
      border-radius: 999px;
      background: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #111827;
    }

    .brand-outside {
      position: fixed;
      left: 270px;
      top: 12px;
      z-index: 35;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: left 0.2s ease-out, top 0.2s ease-out;
    }

    .shell.sidebar-collapsed .brand-outside {
      left: 40px;
      top: 48px;
    }

    .brand-outside-label {
      padding: 0;
      border-radius: 0;
      border: none;
      background: transparent;
    }

    .sidebar-toggle-open {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-main);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .shell.sidebar-collapsed .sidebar-toggle-open {
      display: inline-flex;
    }

    .sidebar-toggle-open:hover {
      background: transparent;
    }

    /* ===== Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… (Ø§Ù„Ø³ÙˆÙŠØªØ´) ===== */
    .theme-toggle {
      position: fixed;
      right: 12px;
      top: 8px;
      z-index: 45;
      transition: left 0.3s ease, right 0.3s ease;
    }
    
    body[dir="rtl"] .theme-toggle {
      right: auto;
      left: 12px;
    }

    .switch {
      font-size: 14px;
      position: relative;
      display: inline-block;
      width: 2.8em;
      height: 1.6em;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #171717;
      box-shadow: inset 2px 4px 8px rgba(0,0,0,0.4);
      transition: .4s;
      border-radius: 5px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 1.2em;
      width: 0.15em;
      border-radius: 0;
      left: 0.35em;
      bottom: 0.2em;
      background-color: #ffffff;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #F2F1ED;
      box-shadow: inset 2px 4px 8px rgba(0,0,0,0.15);
    }

    input:checked + .slider:before {
      transform: translateX(2.0em) rotate(360deg);
    }

    /* ===== Main area ===== */
    .main {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 32px;
    }

    .center-wrap {
      max-width: 860px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-inline: auto;
    }

    .hero-title {
      font-size: 22px;
      font-weight: 500;
      text-align: center;
      margin: 0 0 4px;
      color: var(--text-muted);
    }

    /* ===== Chat log ===== */
    .chat-log {
      width: 100%;
      max-width: 860px;
      margin-inline: auto;
      flex: 1;
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      scrollbar-width: none;
      padding-inline: 4px;
      padding-block: 8px 2px;
    }

    .chat-log::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .msg-row {
      display: flex;
      margin-bottom: 8px;
    }

    .msg-row.rtl {
      justify-content: flex-end;
    }

    .msg-row.ltr {
      justify-content: flex-start;
    }

    .msg-bubble {
      max-width: 80%;
      border-radius: 16px;
      padding: 8px 11px;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      border: 1px solid transparent;
    }

    .msg-bubble.rtl {
      direction: rtl;
      text-align: right;
    }

    .msg-bubble.ltr {
      direction: ltr;
      text-align: left;
    }

    .msg-row.user .msg-bubble {
      background: var(--msg-user-bg);
      border-color: var(--border-subtle);
    }

    .msg-row.bot .msg-bubble {
      background: transparent;
      border: none;
      padding-inline: 0;
    }

    .msg-author {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .thinking-text {
      font-size: 13px;
      font-weight: 400;
      background: linear-gradient(120deg, rgba(255,255,255,0.25) 0%, #ffffff 50%, rgba(255,255,255,0.25) 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: shimmer 2.0s infinite linear;
    }

    body.theme-light .thinking-text{
      color:#000000 !important;
      background:none !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      -webkit-text-fill-color:#000000 !important;
      animation:none !important;
    }


    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .thinking-dots { 
      display:inline-flex; 
      gap:4px; 
      margin-left:8px; 
      vertical-align:middle; 
    }

    .thinking-dots span{ 
      width:7px; 
      height:7px; 
      border-radius:50%; 
      background:var(--text-muted); 
      opacity:0.9; 
      animation:bounce .9s infinite ease-in-out; 
    }

    .thinking-dots span:nth-child(2){ animation-delay:120ms; } 
    .thinking-dots span:nth-child(3){ animation-delay:240ms; }

    @keyframes bounce { 
      0%{transform:translateY(0);opacity:.6;} 
      50%{transform:translateY(-4px);opacity:1;} 
      100%{transform:translateY(0);opacity:.6;} 
    }

    body.theme-light .thinking-dots span{ background: #6b7280; }

    /* ===== Input card ===== */
    .prompt-card {
      position: relative;
      width: 100%;
      max-width: 860px;
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid var(--border-subtle);
      padding: 16px 16px;
      display: flex;
      min-height: 88px;
      align-items: flex-end;
      gap: 8px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      margin-inline: auto;
      transition: border-radius 0.12s ease-out, box-shadow 0.12s ease-out;
    }

    .prompt-card:focus-within {
      border-color: #4a88ff;
      box-shadow: 0 0 0 1px rgba(74, 136, 255, 0.55), 0 22px 48px rgba(0, 0, 0, 0.5);
    }

    body.theme-light .prompt-card {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }

    .plus-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 22px;
      align-self: flex-end;
    }

    body.theme-light .plus-btn {
      background: transparent;
      color: #111827;
    }

    .plus-btn:hover {
      background: rgba(63, 63, 70, 0.35);
    }

    body.theme-light .plus-btn:hover {
      background: rgba(156, 163, 175, 0.35);
    }

    .prompt-input-wrap {
      flex: 1;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      border-radius: 0;
      background: var(--bg-card);
      padding-inline: 10px;
    }

    .prompt-input-prefix {
      display: none;
    }

    .prompt-input {
      flex: 1;
      border-radius: 0;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-size: 15px;
      padding: 8px 0;
      outline: none;
      resize: none;
      overflow-y: hidden;
      max-height: 140px;
      scrollbar-width: none;
    }

    .prompt-input::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .prompt-input::placeholder {
      color: var(--text-muted);
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      align-self: flex-end;
    }

    .icon-btn:hover {
      background: #2d2f35;
      color: #e5e7eb;
    }

    body.theme-light .icon-btn:hover {
      background: #e5e7eb;
      color: #111827;
    }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: #4b5563;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: none;
      transition: transform 0.08s ease-out, opacity 0.1s, background 0.12s, color 0.12s;
      align-self: flex-end;
    }

    body.theme-light .send-btn {
      background: #d1d5db;
      color: #9ca3af;
    }

    .send-btn.ready {
      background: #f9fafb;
      color: #111827;
    }

    body.theme-light .send-btn.ready {
      background: #111827;
      color: #f9fafb;
    }

    
    .send-btn.stop-mode {
      background: #ffffff !important;
      color: #111827 !important;
    }
.send-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .send-btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .send-btn.svg {
      width: 18px;
      height: 18px;
    }

    /* ===== Plus menu ===== */
    .plus-menu {
      position: absolute;
      left: 12px;
      bottom: 56px;
      min-width: 180px;
      background: #353535;
      border-radius: 12px;
      border: 1px solid #27272f;
      padding: 6px 0;
      display: none;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 20;
    }

    body.theme-light .plus-menu {
      background: #ECEAE4 !important;
      border-color: #d1d5db;
    }

    .plus-menu.open {
      display: flex;
    }

    .plus-menu button {
      padding: 10px 14px !important;
      margin: 4px 0 !important;
      display: flex;
      align-items: center;
      gap: 8px !important;
      font-size: 14px !important;
      background: transparent !important;
      border-radius: 6px;
      transition: background 0.15s ease;
      border: none;
      color: var(--text-main);
      cursor: pointer;
      text-align: left;
    }

    .plus-menu button:hover {
      background: rgba(255,255,255,0.05) !important;
    }

    body.theme-light .plus-menu button:hover {
      background: rgba(0,0,0,0.08) !important;
    }

    /* Settings button & menu */
    .settings-btn{
      position: fixed;
      right: 60px;
      top: 8px;
      z-index: 50;
      cursor: pointer;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: transparent;
      color: var(--text-main);
      border: none;
      transition: left 0.3s ease, right 0.3s ease;
    }
    
    body[dir="rtl"] .settings-btn {
      right: auto;
      left: 60px;
    }

    body.theme-light .settings-btn{ 
      color: var(--text-main); 
    }

    .settings-menu{
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 120;
      width: min(720px, 100% - 40px);
      max-height: 82vh;
      padding: 24px 24px 20px;
      border-radius: 14px;
      background: var(--bg-sidebar);
      color: var(--text-main);
      box-shadow: 0 20px 45px rgba(0,0,0,0.5);
      border: 1px solid var(--border-subtle);
      font-size: 13px;
      overflow-y: auto;
      scrollbar-width: none; /* Firefox: hide scrollbar but keep scrolling */
    }

    .settings-menu::-webkit-scrollbar {
      width: 0px;  /* Chrome/Safari: hide vertical scrollbar */
      height: 0px;
      background: transparent;
    }

    .settings-menu::-webkit-scrollbar-track {
      background: transparent;
    }
    
    body[dir="rtl"] .settings-menu {
      right: auto;
      left: 60px;
    }

    .settings-menu .settings-header{
      font-weight:600;
      margin-bottom:12px;
      color: var(--text-main);
      font-size: 14px;
    }

    .settings-menu label{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:10px; 
      font-size:13px;
      margin-bottom: 10px;
    }

    .settings-menu input[type="range"]{ 
      width:110px;
      cursor: pointer;
    }

    .settings-menu input[type="color"] {
      width: 50px;
      height: 30px;
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      cursor: pointer;
    }

    /* Home button */
    .home-btn {
      position: fixed;
      right: 100px;
      top: 8px;
      z-index: 50;
      cursor: pointer;
      font-size: 18px;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: transparent;
      color: var(--text-main);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      transition: left 0.3s ease, right 0.3s ease, transform 0.2s ease;
    }
    
    body[dir="rtl"] .home-btn {
      right: auto;
      left: 100px;
    }

    .home-btn:hover {
      transform: scale(1.15);
    }

    /* Sidebar chat item menu */
    .nav-item .chat-dots {
      margin-left: auto;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0;
      transition: 0.12s ease;
      color: var(--text-muted);
    }

    .nav-item:hover .chat-dots { 
      opacity: 1; 
    }

    .chat-menu {
      background: #353535 !important;
      position: absolute;
      right: 0;
      top: 32px;
      min-width: 180px;
      border: 1px solid var(--border-subtle);
      padding: 8px 0;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      z-index: 100;
    }

    .chat-menu.open { 
      display: flex; 
    }

    .chat-menu button {
      background: none;
      border: none;
      padding: 8px 14px;
      text-align: left;
      font-size: 13px;
      cursor: pointer;
      color: #ffffff !important;
      }

    .chat-menu button:hover {
      background: rgba(255,255,255,0.05);
    }

    .chat-menu .danger {
      color: #C46E6D;
    }

    @media (prefers-color-scheme: light) {
      .chat-menu {
        background: #ECEAE4 !important;
      }
    }

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .brand-outside {
        left: 16px;
        top: 50px;
      }
      .theme-toggle {
        top: 8px;
        right: 12px;
      }
      .main {
        padding: 18px 12px;
      }
      .prompt-card {
        border-radius: 18px;
      }
    }

    /* Modal Styles */
    .confirm-modal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-content {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 14px;
      width: 360px;
      color: #fff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    body.theme-light .modal-content {
      background: #ffffff;
      color: #111827;
    }

    .modal-content h3 {
      margin: 0 0 10px;
      font-size: 18px;
    }

    .modal-content p {
      color: #ddd;
      font-size: 13px;
      margin-bottom: 16px;
    }

    body.theme-light .modal-content p {
      color: #6b7280;
    }

    .modal-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2a2a2a;
      color: #fff;
      margin-bottom: 16px;
      font-size: 14px;
      outline: none;
    }

    body.theme-light .modal-input {
      background: #f9fafb;
      border: 1px solid #d1d5db;
      color: #111827;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 6px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: opacity 0.15s;
    }

    .modal-btn:hover {
      opacity: 0.85;
    }

    .modal-btn-cancel {
      background: #333;
      color: #fff;
    }

    body.theme-light .modal-btn-cancel {
      background: #e5e7eb;
      color: #111827;
    }

    .modal-btn-confirm {
      background: #4a88ff;
      color: #fff;
    }

    .modal-btn-delete {
      background: #C46E6D;
      color: #fff;
    }

    /* Advanced Settings Sections */
    .settings-section {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .settings-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .setting-item {
      margin-bottom: 12px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      font-size: 13px;
      color: var(--text-main);
      margin-bottom: 6px;
      display: block;
    }

    .setting-description {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    select.setting-select {
      width: 100%;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-input);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      outline: none;
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: #3f3f46;
      border-radius: 999px;
      position: relative;
      transition: background 0.2s;
      cursor: pointer;
      display: inline-block;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 999px;
      top: 2px;
      left: 2px;
      transition: left 0.2s;
    }

    .toggle-switch.active::after {
      left: 20px;
    }

    .range-value {
      display: inline-block;
      min-width: 50px;
      text-align: right;
      font-size: 12px;
      color: var(--text-muted);
    }
  
/* ===== Pro Patches (no layout changes) ===== */
body { --chat-text: inherit; }
.chat-log, .chat-log .message, .chat-log .message * { color: var(--chat-text); }
.prompt-input, .hero-title { color: var(--chat-text); }

.message.is-ar { direction: rtl; text-align: right; }
.message.is-en { direction: ltr; text-align: left; }

/* Light theme chat list scrollbar: auto-hide + very subtle */
body.theme-light .nav-list::-webkit-scrollbar { width: 5px; }
body.theme-light .nav-list::-webkit-scrollbar-track { background: transparent; }
body.theme-light .nav-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 999px; }
body.theme-light .nav-list:not(.scrolling)::-webkit-scrollbar-thumb { background: transparent; }
body.theme-light .nav-list { scrollbar-color: transparent transparent; scrollbar-width: thin; }
body.theme-light .nav-list.scrolling { scrollbar-color: rgba(0,0,0,0.12) transparent; }

.setting-warning{ margin-top:6px; font-size:12px; opacity:0.8; }
.setting-warning.hidden{ display:none; }


    /* ===== Capabilities Card ===== */
    .cap-card{
      margin: 12px auto 14px;
      width: min(980px, 100%);
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    body.theme-light .cap-card{
      border-color: rgba(0,0,0,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .cap-toggle{
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      background: transparent;
      border: 0;
      cursor: pointer;
      color: var(--text);
      font-weight: 700;
      letter-spacing: .2px;
    }
    .cap-title{ font-size: 14px; }
    .cap-chev{ opacity:.8; transition: transform .18s ease; }
    .cap-card[data-open="true"] .cap-chev{ transform: rotate(180deg); }
    .cap-body{
      padding: 0 16px 14px;
    }
    .cap-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      padding-top: 6px;
    }
    @media (max-width: 860px){
      .cap-grid{ grid-template-columns: 1fr; }
    }
    .cap-col h3{
      margin: 10px 0 8px;
      font-size: 13px;
      opacity: .92;
    }
    .cap-col ul{
      margin: 0;
      padding: 0 18px 0 0;
      line-height: 1.85;
      font-size: 13px;
      opacity: .92;
    }
    .cap-col li{ margin: 4px 0; }


    /* ===== Sidebar search ===== */
    .chat-search-wrap{
      margin: 2px 6px 2px;
      padding: 0;
    }
    .chat-search{
      width: 100%;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-main);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
    }
    .chat-search::placeholder{ color: var(--text-muted); }
    .chat-search:focus{
      border-color: rgba(74,136,255,.55);
      box-shadow: 0 0 0 1px rgba(74,136,255,.35);
    }


    /* ===== Disable page vertical scroll (keep chat log scroll only) ===== */
    html, body {
      height: 100%;
      overflow: hidden !important;
      overscroll-behavior: none;
      touch-action: pan-x; /* prevent page vertical scroll on touch */
    }


    /* ===== Patch: Always show chat menu dots (â‹¯) + proper contrast in light theme ===== */
    .nav-item:hover .chat-dots { opacity: 1 !important; }
    body.theme-light .chat-menu button { color: #111827 !important; }

    /* ===== Patch: Voice active state ===== */
    .icon-btn.voice-active { background: var(--accent-soft); color: var(--text-main); }


    /* ===== Chat dots: show only on hover ===== */
    .nav-item .chat-dots{
      opacity: 0;
      pointer-events: auto;
      transition: opacity .15s ease;
    }
    .nav-item:hover .chat-dots{
      opacity: 1;
    }

    /* ===== Voice button: bigger, outline icon (black) ===== */
    #voiceBtn{
      width: 44px;
      height: 44px;
    }
    #voiceBtn .mic-icon{
      width: 22px;
      height: 22px;
      display: block;
    }
    body.theme-light #voiceBtn{
      color: #000; /* outline black */
    }
    body.theme-dark #voiceBtn{
      color: #fff; /* keep visible on dark */
    }

    /* ===== Chat menu panel background in light theme ===== */
    body.theme-light .chat-menu .menu-panel,
    body.theme-light .chat-menu .menu,
    body.theme-light .chat-menu .dropdown{
      background: #fff !important;
    }

    /* ===== Delete (English) in red on both themes ===== */
    .chat-menu button[data-action="delete"],
    .chat-menu .menu-panel button[data-action="delete"],
    .chat-menu .menu button[data-action="delete"]{
      color: #ef4444 !important;
    }


    /* ===== OVERRIDE: chat dots only on hover ===== */
    .nav-item .chat-dots{
      opacity: 0 !important;
      pointer-events: auto;
      transition: opacity .15s ease;
    }
    .nav-item:hover .chat-dots{
      opacity: 1 !important;
    }

    /* ===== OVERRIDE: light theme chat menu background must be white ===== */
    body.theme-light .chat-menu{
      background: #ffffff !important;
    }

    /* ===== OVERRIDE: Delete (English label) red in both themes ===== */
    .chat-menu button.danger,
    .chat-menu button.delete-option{
      color: #ef4444 !important;
    }

    /* ===== OVERRIDE: bigger mic button + outline icon ===== */
    #voiceBtn{
      width: 48px !important;
      height: 48px !important;
    }
    #voiceBtn .mic-icon{
      width: 24px !important;
      height: 24px !important;
    }
    body.theme-light #voiceBtn{ color:#000 !important; }
    body.theme-dark  #voiceBtn{ color:#fff !important; }


    /* ===== OVERRIDE: chat options hover effect in light theme ===== */
    body.theme-light .chat-menu button{
      transition: background .12s ease, color .12s ease, transform .12s ease;
      border-radius: 10px;
    }
    body.theme-light .chat-menu button:hover{
      background: #f3f4f6 !important; /* subtle light hover */
      color: #111827 !important;
      transform: translateY(-1px);
    }
    body.theme-light .chat-menu button.danger:hover,
    body.theme-light .chat-menu button.delete-option:hover{
      background: #fee2e2 !important; /* soft red hover for delete */
      color: #b91c1c !important;
    }


    /* ===== Outline nav icons (home/settings) ===== */
    .nav-icon{
      width: 18px;
      height: 18px;
      display: block;
    }


    /* ===== Mic icon: gray, hover black (light theme) ===== */
    body.theme-light #voiceBtn{
      color: #6b7280 !important; /* gray */
    }
    body.theme-light #voiceBtn:hover{
      color: #000000 !important; /* black on hover */
    }

    /* ===== Home + Settings: scale on hover ===== */
    .home-btn, #settingsBtn{
      transition: transform .12s ease, color .12s ease, background .12s ease;
    }
    .home-btn:hover, #settingsBtn:hover{
      transform: scale(1.12);
    }

    /* ===== Align voice button with send button + slightly smaller ===== */
    #voiceBtn{
      width: 40px !important;
      height: 40px !important;
      align-self: center !important;
      margin-bottom: 0 !important;
    }
    #voiceBtn .mic-icon{
      width: 20px !important;
      height: 20px !important;
    }
    /* Ensure actions row centers items */
    .composer-actions{
      align-items: center !important;
    }


/* ===== PATCH: menu z-index on top ===== */
.dropdown-menu,
.context-menu,
.menu-popover,
.popover,
.menu {
  z-index: 99999 !important;
  position: relative;
}


/* ===== PATCH: align voice button with send ===== */
#voiceBtn.icon-btn{
  width: 36px;
  height: 36px;
}




/* ===== PATCH: pin footer without visual changes ===== */
aside{
  display:flex;
  flex-direction:column;
  height:100vh;
  /* Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª */
}
#chatList.nav-list{
  flex:1;
  overflow-y:auto;
  max-height:none;
}
.sidebar-footer{
  position:sticky;
  bottom:0;
  z-index:5000;
  background:transparent !important; /* Ù„Ø§ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ */
  border-top: 1px solid #000; /* ÙƒÙ…Ø§ ÙƒØ§Ù† */
}


/* ===== PATCH: sidebar avatar green + softer radii ===== */
/* 1) Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø®Ø¶Ø±Ø§Ø¡ */
.user-avatar{
  width:36px;
  height:36px;
  border-radius:999px;
  background:#22c55e;
  color:#ffffff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font:800 13px/1 Inter;
}

/* 2) ØªØ®ÙÙŠÙ ØªÙ‚ÙˆÙŠØ³ Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª */
.nav-item{
  border-radius:14px !important;
}

/* 3) ØªØ®ÙÙŠÙ ØªÙ‚ÙˆÙŠØ³ Ø§Ù„Ø¨Ø­Ø« */
.chat-search{
  border-radius:14px !important;
}

/* 4) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªØ®Ø±Ø¬ Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ scroll) */
.dropdown-menu,
.context-menu,
.menu-popover,
.popover,
.menu{
  z-index: 99999 !important;
  position: fixed !important;
}


/* ===== PATCH: adjust rounding + avatar weight + mic position ===== */
/* 1) ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠØ³ (Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚) */
.nav-item{ border-radius:10px !important; }
.chat-search{ border-radius:10px !important; }

/* 2) Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±ÙŠØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
.user-avatar{ font-weight:500 !important; }

/* 3) Ø¥Ù†Ø²Ø§Ù„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø£Ø³ÙÙ„ ÙƒÙ…Ø§ ÙƒØ§Ù†Øª (Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø¬Ù…Ù‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ) */
#voiceBtn.icon-btn{
  width:32px !important;
  height:32px !important;
}


/* ===== PATCH: mic fixed position + chat menu above footer ===== */
/* 1) Ø¥Ù†Ø²Ø§Ù„ Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ«Ø¨ÙŠØªÙ‡ (Ù„Ø§ ÙŠØªØ­Ø±Ùƒ Ù…Ø¹ ØªÙ…Ø¯Ø¯ Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©) */
#voiceBtn{
  align-self: flex-end !important;
  margin-top: auto !important;
  margin-bottom: -2px !important; /* ÙŠÙ†Ø²Ù„ Ø¨Ø³ÙŠØ· Ø¨Ù…Ø­Ø§Ø°Ø§Ø© Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
  flex: 0 0 auto !important;
}

/* 2) Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· ÙÙˆÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.chat-menu{
  z-index: 6000 !important; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† .sidebar-footer (5000) */
}


/* ===== PATCH: align brand label with arrow ===== */
.brand-outside-label{
  position: relative;
  top: 2px; /* Ø§Ù†Ø²Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØ­Ø§Ø°ÙŠ Ø§Ù„Ø³Ù‡Ù… */
}


/* ===== PATCH: align brand label with arrow v2 ===== */
.brand-outside-label{
  top: 6px !important; /* Ø§Ù†Ø²Ø§Ù„ Ø¥Ø¶Ø§ÙÙŠ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø³Ù‡Ù… */
}


/* ===== PATCH: brand label down+right+bold ===== */
.brand-outside-label{
  top: 8px !important;
  left: 4px !important;
  font-weight: 800 !important;
}


/* ===== PATCH: brand label down+right+bold v2 ===== */
.brand-outside-label{
  top: 10px !important;
  left: 6px !important;
  font-weight: 900 !important;
}


/* ===== PATCH: brand label position + bold + collapsed alignment ===== */
/* ØªØ­Ø±ÙŠÙƒ OAP AI Ù„Ù„Ø£Ø³ÙÙ„ Ù‚Ù„ÙŠÙ„Ù‹Ø§ ÙˆÙ„Ù„ÙŠÙ…ÙŠÙ† Ù‚Ù„ÙŠÙ„Ù‹Ø§ + Ø¨ÙˆÙ„Ø¯ */
.brand-outside-label{
  position: relative;
  top: 10px !important;
  left: 10px !important;
  font-weight: 800 !important;
}

/* Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø©: Ø§Ø¬Ø¹Ù„ OAP AI Ø¨Ø¬Ø§Ù†Ø¨ Ø³Ù‡Ù… Ø§Ù„ÙØªØ­ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
.sidebar-collapsed .brand-outside{
  left: 14px !important;
  top: 12px !important;
}

</style>
</head>
<body>
<div class="shell" id="shell">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand-row">
      <span class="brand-dot"></span>
      <span class="brand-title">OAP AI</span>
    </div>

    <button id="sidebarToggleClose" class="sidebar-toggle-close" type="button" title="Close sidebar">â®</button>

    <button id="newChatSidebar" class="new-chat-btn" type="button">
      + New chat
    </button>

    <!-- Search -->
    <div class="chat-search-wrap">
      <input id="chatSearch" class="chat-search" type="text" placeholder="Search chatsâ€¦" autocomplete="off" />
    </div>


    <div class="nav-section-title">Chats</div>
    <div id="chatList" class="nav-list"></div>

    <div class="sidebar-footer">
      <div class="user-pill">
        <div class="user-avatar" id="sidebarUserAvatar">KA</div>
        <span id="sidebarUserName">Loading...</span>
      </div>
      <span>Plus</span>
    </div>
  </aside>

  <!-- OAP AI + Ø²Ø± ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© -->
  <div class="brand-outside">
    <span class="brand-outside-label">OAP AI</span>
    <button id="sidebarToggleOpen" class="sidebar-toggle-open" type="button" title="Open sidebar">â¯</button>
  </div>

  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… (Ø§Ù„Ø³ÙˆÙŠØªØ´) -->
  <div class="theme-toggle">
    <!-- Home Button -->
    <a href="index.html" class="home-btn" title="Home">
      <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 10.5 12 3l9 7.5v9.5a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-6H11v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-9.5Z"
              fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>

    <!-- Settings Button -->
    <button id="settingsBtn" class="settings-btn" title="Settings"><svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
  <path d="M21 4H14" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M10 4H3" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M21 12H12" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M8 12H3" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M21 20H16" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M13 20H3" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M14 2v4" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M8 10v4" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
  <path d="M16 18v4" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
</svg></button>
    <div id="settingsMenu" class="settings-menu" aria-hidden="true">
      <!-- Appearance Section -->
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="setting-item">
          <label class="setting-label">Font Size</label>
          <label style="display:flex;align-items:center;gap:10px;">
            <input id="fontSizeInput" type="range" min="12" max="22" value="15">
            <span class="range-value" id="fontSizeValue">15px</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="setting-label">Font Color</label>
          <input id="fontColorInput" type="color" value="#ffffff">
        
          <div id="fontColorWarn" class="setting-warning hidden"></div>
</div>
      </div>

      <!-- Language Section -->
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="setting-item">
          <label class="setting-label">Interface Language</label>
          <div class="setting-description">Choose your preferred language</div>
          <select class="setting-select" id="languageSelect">
            <option value="en">English</option>
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          </select>
        </div>
      </div>

      <!-- AI Model Section -->
      <div class="settings-section">
        <div class="settings-section-title">AI Model</div>
        <div class="setting-item">
          <label class="setting-label">Model Selection</label>
          <div class="setting-description">Choose AI model for responses</div>
          <select class="setting-select" id="modelSelect">
            <option value="claude-sonnet-4">Claude Sonnet 4</option>
            <option value="claude-opus-4">Claude Opus 4</option>
            <option value="claude-haiku-4">Claude Haiku 4</option>
          </select>
        </div>
      </div>

      <!-- Advanced Settings -->
      <div class="settings-section">
        <div class="settings-section-title">Advanced</div>
        <div class="setting-item">
          <label style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div class="setting-label" style="margin-bottom:2px;">Stream Response</div>
              <div class="setting-description">Enable real-time streaming</div>
            </div>
            <div class="toggle-switch active" id="streamToggle"></div>
          </label>
        </div>
        <div class="setting-item">
          <label style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div class="setting-label" style="margin-bottom:2px;">Auto Scroll</div>
              <div class="setting-description">Scroll to new messages</div>
            </div>
            <div class="toggle-switch active" id="autoScrollToggle"></div>
          </label>
        </div>
        <div class="setting-item">
          <label class="setting-label">Response Speed</label>
          <div class="setting-description">Adjust typing animation speed</div>
          <label style="display:flex;align-items:center;gap:10px;">
            <input id="speedSlider" type="range" min="10" max="50" value="25">
            <span class="range-value" id="speedValue">25ms</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="setting-label">Max Response Length</label>
          <div class="setting-description">Maximum tokens per response</div>
          <label style="display:flex;align-items:center;gap:10px;">
            <input id="tokensSlider" type="range" min="512" max="4096" step="512" value="2048">
            <span class="range-value" id="tokensValue">2048</span>
          </label>
        </div>
      </div>

      <!-- Data Management -->
      <div class="settings-section">
        <div class="settings-section-title">Data</div>
        <div class="setting-item">
          <button class="modal-btn modal-btn-confirm" id="exportBtn" style="width:100%;">
            ğŸ“¥ Export All Chats
          </button>
        </div>
        <div class="setting-item">
          <button class="modal-btn modal-btn-delete" id="clearAllBtn" style="width:100%;">
            ğŸ—‘ï¸ Clear All Data
          </button>
        </div>
      </div>
    </div>

    <!-- Theme Switch -->
    <label class="switch">
      <input type="checkbox" id="themeToggle" />
      <span class="slider"></span>
    </label>
  </div>

  <!-- Main -->
  <main class="main">
    <div class="center-wrap">
      <h1 class="hero-title" dir="rtl">Ø¨Ù…Ø§Ø°Ø§ ØªØ±ØºØ¨ Ø£Ù† Ù†Ø¨Ø¯Ø£ØŸ</h1>
<!-- Chat log -->
      <section id="chatLog" class="chat-log"></section>

      <!-- Input card -->
      <section class="prompt-card">
        <button id="plusBtn" class="plus-btn" type="button">+</button>

        <!-- Menu -->
        <div id="plusMenu" class="plus-menu">
          <button id="menuNewChat" type="button"><span>New chat</span></button>
          <button id="menuUpload" type="button"><span class="icon">ğŸ“</span><span>Upload files</span></button>
        </div>

        <div class="prompt-input-wrap">
          <span class="prompt-input-prefix">+</span>
          <textarea id="userInput" class="prompt-input" rows="1"
                    placeholder="Ask anything about OAP operationsâ€¦" autocomplete="off"></textarea>
        </div>

        <button id="voiceBtn" class="icon-btn" type="button" title="Voice"><svg class="mic-icon" viewBox="0 0 24 24" aria-hidden="true">
  <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M19 11a7 7 0 0 1-14 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  <path d="M12 18v3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  <path d="M8 21h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg></button>
        <button id="sendBtn" class="send-btn" type="button" title="Send">
          <svg id="sendIconArrow" viewBox="0 0 24 24" fill="none">
            <path d="M4 4L20 12L4 20L7 12L4 4Z"
                  stroke="currentColor"
                  stroke-width="1.7"
                  stroke-linejoin="round"/>
          </svg>
        </button>
      </section>
    </div>
  </main>
</div>

<input id="fileInput" type="file" multiple style="display:none" />

<!-- Toast -->
<div id="toast" style="position:fixed;left:50%;bottom:22px;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,0.75);color:#fff;font-size:13px;z-index:250;display:none;max-width:min(520px,calc(100% - 24px));text-align:center;backdrop-filter: blur(6px);"></div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="confirm-modal">
  <div class="modal-content">
    <h3>Delete this chat?</h3>
    <p>This will delete the chat permanently.</p>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" id="cancelDelete">Cancel</button>
      <button class="modal-btn modal-btn-delete" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="confirm-modal">
  <div class="modal-content">
    <h3>Rename chat</h3>
    <input id="renameInput" type="text" class="modal-input" placeholder="Enter new name">
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" id="cancelRename">Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="confirmRename">Save</button>
    </div>
  </div>
</div>

<!-- Clear All Data Modal -->
<div id="clearAllModal" class="confirm-modal">
  <div class="modal-content">
    <h3>Clear all data?</h3>
    <p>This will permanently delete all your conversations and settings.</p>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" id="cancelClearAll">Cancel</button>
      <button class="modal-btn modal-btn-delete" id="confirmClearAll">Clear All</button>
    </div>
  </div>
</div>

<script>
  // ===== Configuration & State =====
  const API_BASE = "https://oap-backend-875458188350.europe-west1.run.app";

/* ===== PATCH: sidebar user name from oap_session_v1 ===== */
  // Populate sidebar footer user info from sessionStorage (set at login)
  (function(){
    function safeParse(s){ try { return JSON.parse(s); } catch(e){ return null; } }
    function initials(name){
      const s = String(name || "").trim();
      if(!s) return "--";
      const parts = s.split(/\s+/);
      const a = parts[0]?.[0] || "";
      const b = parts[1]?.[0] || parts[0]?.[1] || "";
      return (a + b).toUpperCase() || "--";
    }

    const avatarEl = document.getElementById("sidebarUserAvatar");
    const nameEl = document.getElementById("sidebarUserName");
    if(!avatarEl || !nameEl) return;

    const sess = safeParse(sessionStorage.getItem("oap_session_v1"));
    const displayName = sess?.employee_name || sess?.employeeName || "";
    const email = sess?.email || localStorage.getItem("oap_email") || "";

    const finalName = displayName || email || "User";
    avatarEl.textContent = initials(finalName);
    nameEl.textContent = finalName;
  })();

async function sendToNXS(userText) {
  // Use AbortController so the "Stop" button can actually cancel the request.
  const res = await fetch(`${API_BASE}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    signal: abortController ? abortController.signal : undefined,
    body: JSON.stringify({ message: userText })
  });

  if (!res.ok) {
    // Try to surface useful error info
    let t = "";
    try { t = await res.text(); } catch (e) {}
    const err = new Error(`HTTP ${res.status} ${res.statusText}${t ? " - " + t : ""}`);
    err.name = "NetworkError";
    throw err;
  }

  const data = await res.json();
  return data;
}
const shellEl = document.getElementById("shell");
  const sidebarToggleOpenEl = document.getElementById("sidebarToggleOpen");
  const sidebarToggleCloseEl = document.getElementById("sidebarToggleClose");
  const chatListEl = document.getElementById("chatList");
  const chatSearchEl = document.getElementById("chatSearch");
  const chatLogEl = document.getElementById("chatLog");
  const heroTitleEl = document.querySelector(".hero-title");
  const userInputEl = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const newChatSidebarBtn = document.getElementById("newChatSidebar");
  const plusBtn = document.getElementById("plusBtn");
  const plusMenu = document.getElementById("plusMenu");
  const menuNewChat = document.getElementById("menuNewChat");
  const menuUpload = document.getElementById("menuUpload");
  const fileInput = document.getElementById("fileInput");
  const themeToggleInput = document.getElementById("themeToggle");
  const promptCardEl = document.querySelector(".prompt-card");

  const voiceBtn = document.getElementById("voiceBtn");

  // ===== Patch: Voice Input (Web Speech API) =====
  let _sr = null;
  let _srActive = false;

  function supportsSpeech(){
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  }

  function initSpeech(){
    if (_sr) return _sr;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    _sr = new SR();
    _sr.continuous = false;
    _sr.interimResults = true;
    _sr.maxAlternatives = 1;

    _sr.onstart = () => {
      _srActive = true;
      if (voiceBtn) voiceBtn.classList.add("voice-active");
    };

    _sr.onresult = (event) => {
      let finalText = "";
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const txt = event.results[i][0]?.transcript || "";
        if (event.results[i].isFinal) finalText += txt;
        else interim += txt;
      }
      const combined = (finalText || interim).trim();
      if (combined) {
        const cur = (userInputEl.value || "").trim();
        userInputEl.value = cur ? (cur + " " + combined) : combined;
        autoResizeTextarea();
        userInputEl.focus();
      }
    };

    _sr.onerror = (e) => {
      _srActive = false;
      if (voiceBtn) voiceBtn.classList.remove("voice-active");
    };

    _sr.onend = () => {
      _srActive = false;
      if (voiceBtn) voiceBtn.classList.remove("voice-active");
    };

    return _sr;
  }

  function startVoice(){
    const sr = initSpeech();
    if (!sr) {
      toast((settings.language === "ar") ? "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ." : "Browser does not support voice dictation.");
      return;
    }
    sr.lang = (settings.language === "ar") ? "ar-SA" : "en-US";
    try { sr.start(); } catch (e) { console.warn(e); }
  }

  function stopVoice(){
    try { if (_sr) _sr.stop(); } catch (e) { console.warn(e); }
  }


  const MAX_TEXTAREA_HEIGHT = 140;

  // Sidebar chat search
  if (chatSearchEl) {
    chatSearchEl.addEventListener('input', () => {
      scheduleRenderChatList();
    });
  }


  // Settings State with Enhanced Features
  let settings = {
    fontSize: 15,
    fontColorLight: '#111827',
    fontColorDark: '#ffffff',
    language: 'en',
    model: 'claude-sonnet-4',
    stream: true,
    autoScroll: true,
    speed: 25,
    maxTokens: 2048
  };

  let conversations = {};
  let currentChatId = null;
  let chatCounter = 1;
  let thinkingRow = null;
  let abortController = null;
  let typingActive = false;
  let typingAbort = false;
  let lastTypingPromise = Promise.resolve();

  let _lastSendAt = 0;
  let _lastSendText = "";
// ===== Load/Save Settings =====
  function loadSettings() {
    try {
      const saved = localStorage.getItem('tcc_settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
      }
      applySettings();
    } catch (e) {
      console.warn('Failed to load settings', e);
    }
  }

  function saveSettings() {
    try {
      localStorage.setItem('tcc_settings', JSON.stringify(settings));
    } catch (e) {
      console.warn('Failed to save settings', e);
    }
  }

  function applySettings() {
    // Font size
    document.body.style.fontSize = settings.fontSize + 'px';
    document.getElementById('fontSizeInput').value = settings.fontSize;
    document.getElementById('fontSizeValue').textContent = settings.fontSize + 'px';

    // Font color (separate for light/dark)
    const isLightTheme = document.body.classList.contains('theme-light');
    const currentFontColor = isLightTheme ? (settings.fontColorLight || '#111827') : (settings.fontColorDark || '#ffffff');
    document.body.style.color = currentFontColor;
    document.body.style.setProperty('--chat-text', currentFontColor);
    document.getElementById('fontColorInput').value = currentFontColor;

    // Language
    document.getElementById('languageSelect').value = settings.language;

    // Model
    document.getElementById('modelSelect').value = settings.model;

    // Stream toggle
    document.getElementById('streamToggle').classList.toggle('active', settings.stream);

    // Auto scroll toggle
    document.getElementById('autoScrollToggle').classList.toggle('active', settings.autoScroll);

    // Speed
    document.getElementById('speedSlider').value = settings.speed;
    document.getElementById('speedValue').textContent = settings.speed + 'ms';

    // Tokens
    document.getElementById('tokensSlider').value = settings.maxTokens;
    document.getElementById('tokensValue').textContent = settings.maxTokens;
  }

  // ===== Settings Event Listeners =====
  document.getElementById('fontSizeInput').addEventListener('input', (e) => {
    settings.fontSize = parseInt(e.target.value);
    document.body.style.fontSize = settings.fontSize + 'px';
    document.getElementById('fontSizeValue').textContent = settings.fontSize + 'px';
    saveSettings();
  });

  document.getElementById('fontColorInput').addEventListener('input', (e) => {
    const isLightTheme = document.body.classList.contains('theme-light');
    if (isLightTheme) settings.fontColorLight = e.target.value;
    else settings.fontColorDark = e.target.value;
    applyFontColorByTheme();
    saveSettings();
  });
document.getElementById('languageSelect').addEventListener('change', (e) => {
    settings.language = e.target.value;
    saveSettings();
    applyLanguage();
  
  bindNavListAutohide();
  applyFontColorByTheme();
});

  document.getElementById('modelSelect').addEventListener('change', (e) => {
    settings.model = e.target.value;
    saveSettings();
  });

  document.getElementById('streamToggle').addEventListener('click', () => {
    settings.stream = !settings.stream;
    document.getElementById('streamToggle').classList.toggle('active', settings.stream);
    saveSettings();
  });

  document.getElementById('autoScrollToggle').addEventListener('click', () => {
    settings.autoScroll = !settings.autoScroll;
    document.getElementById('autoScrollToggle').classList.toggle('active', settings.autoScroll);
    saveSettings();
  });

  document.getElementById('speedSlider').addEventListener('input', (e) => {
    settings.speed = parseInt(e.target.value);
    document.getElementById('speedValue').textContent = settings.speed + 'ms';
    saveSettings();
  });

  document.getElementById('tokensSlider').addEventListener('input', (e) => {
    settings.maxTokens = parseInt(e.target.value);
    document.getElementById('tokensValue').textContent = settings.maxTokens;
    saveSettings();
  });

  // Export chats
  document.getElementById('exportBtn').addEventListener('click', () => {
    const dataStr = JSON.stringify(conversations, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'tcc-ai-chats-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
    document.getElementById('settingsMenu').style.display = 'none';
  });

  // Clear all data
  document.getElementById('clearAllBtn').addEventListener('click', () => {
    document.getElementById('clearAllModal').style.display = 'flex';
    document.getElementById('settingsMenu').style.display = 'none';
  });

  function applyLanguage() {
    const isArabic = settings.language === 'ar';

    // ØªØ«Ø¨ÙŠØª Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© LTR Ø­ØªÙ‰ Ù„Ø§ ØªØªØ­Ø±Ùƒ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    document.body.setAttribute('dir', 'ltr');

    if (isArabic) {
      userInputEl.placeholder = 'Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¹Ù† Ø¹Ù…Ù„ÙŠØ§Øª OAPâ€¦';
    } else {
      userInputEl.placeholder = 'Ask anything about OAP operationsâ€¦';
    }

    if (chatSearchEl) {
      chatSearchEl.placeholder = isArabic ? 'Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øªâ€¦' : 'Search chatsâ€¦';
    }

    
    // Localize hero title and New chat buttons
    if (heroTitleEl) {
      heroTitleEl.textContent = isArabic ? 'Ø¨Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¨Ø¯Ø£ØŸ' : '?What would you like to start with';
    }
    if (newChatSidebarBtn) {
      newChatSidebarBtn.textContent = isArabic ? '+ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©' : '+ New chat';
    }
    if (menuNewChat) {
      menuNewChat.textContent = isArabic ? 'Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'New chat';
    }
// Localize settings window
    const sectionTitles = document.querySelectorAll('#settingsMenu .settings-section-title');
    const labels = document.querySelectorAll('#settingsMenu .setting-label');
    const descriptions = document.querySelectorAll('#settingsMenu .setting-description');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearAllBtn');

    if (sectionTitles.length >= 5) {
      if (isArabic) {
        sectionTitles[0].textContent = 'Ø§Ù„Ù…Ø¸Ù‡Ø±';
        sectionTitles[1].textContent = 'Ø§Ù„Ù„ØºØ©';
        sectionTitles[2].textContent = 'Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
        sectionTitles[3].textContent = 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©';
        sectionTitles[4].textContent = 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      } else {
        sectionTitles[0].textContent = 'Appearance';
        sectionTitles[1].textContent = 'Language';
        sectionTitles[2].textContent = 'AI Model';
        sectionTitles[3].textContent = 'Advanced';
        sectionTitles[4].textContent = 'Data';
      }
    }

    if (labels.length >= 8) {
      if (isArabic) {
        labels[0].textContent = 'Ø­Ø¬Ù… Ø§Ù„Ø®Ø·';
        labels[1].textContent = 'Ù„ÙˆÙ† Ø§Ù„Ø®Ø·';
        labels[2].textContent = 'Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©';
        labels[3].textContent = 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬';
        labels[4].textContent = 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…ØªØ¯ÙÙ‚Ø©';
        labels[5].textContent = 'ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ';
        labels[6].textContent = 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©';
        labels[7].textContent = 'Ø£Ù‚ØµÙ‰ Ø·ÙˆÙ„ Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©';
      } else {
        labels[0].textContent = 'Font Size';
        labels[1].textContent = 'Font Color';
        labels[2].textContent = 'Interface Language';
        labels[3].textContent = 'Model Selection';
        labels[4].textContent = 'Stream Response';
        labels[5].textContent = 'Auto Scroll';
        labels[6].textContent = 'Response Speed';
        labels[7].textContent = 'Max Response Length';
      }
    }

    if (descriptions.length >= 6) {
      if (isArabic) {
        descriptions[0].textContent = 'Ø§Ø®ØªØ± Ù„ØºØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©';
        descriptions[1].textContent = 'Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
        descriptions[2].textContent = 'ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©';
        descriptions[3].textContent = 'Ø§Ù„ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
        descriptions[4].textContent = 'Ø¶Ø¨Ø· Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©';
        descriptions[5].textContent = 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø·ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©';
      } else {
        descriptions[0].textContent = 'Choose your preferred language';
        descriptions[1].textContent = 'Choose AI model for responses';
        descriptions[2].textContent = 'Enable real-time streaming';
        descriptions[3].textContent = 'Scroll to new messages';
        descriptions[4].textContent = 'Adjust typing animation speed';
        descriptions[5].textContent = 'Maximum tokens per response';
      }
    }

    if (exportBtn && clearBtn) {
      if (isArabic) {
        exportBtn.textContent = 'ğŸ“¥ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª';
        clearBtn.textContent = 'ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      } else {
        exportBtn.textContent = 'ğŸ“¥ Export All Chats';
        clearBtn.textContent = 'ğŸ—‘ï¸ Clear All Data';
      }
    }
  }

  // ===== Sidebar Toggle =====
  sidebarToggleOpenEl.addEventListener("click", () => {
    shellEl.classList.remove("sidebar-collapsed");
  });

  sidebarToggleCloseEl.addEventListener("click", () => {
    shellEl.classList.add("sidebar-collapsed");
  });

  
  // ===== Patch: Voice Button =====
  if (voiceBtn) {
    voiceBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (_srActive) stopVoice();
      else startVoice();
    });
  }

// ===== Theme Toggle =====
  themeToggleInput.addEventListener("change", () => {
    const isLight = themeToggleInput.checked;
    document.body.classList.toggle("theme-light", isLight);
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
        applyFontColorByTheme();
});

  // Load theme preference
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    themeToggleInput.checked = true;
    document.body.classList.add('theme-light');
  }

  
    // Apply initial font color after theme load
  applyFontColorByTheme();
// ===== Conversation Management =====
  // --- Prevent saving empty chats (drafts) ---
  function isEmptyConversation(c){
    if(!c) return true;
    const msgs = Array.isArray(c.messages) ? c.messages : [];
    const title = (c.title || '').trim();
    return msgs.length === 0 && title === '';
  }

  function inferTitleFromMessages(c){
    const msgs = Array.isArray(c.messages) ? c.messages : [];
    const firstUser = msgs.find(m => (m.role === 'user' || m.type === 'user') && (m.content || m.text));
    const raw = (firstUser && (firstUser.content || firstUser.text)) ? String(firstUser.content || firstUser.text).trim() : '';
    if(!raw) return 'New chat';
    return raw.length > 32 ? raw.slice(0, 32) + 'â€¦' : raw;
  }

  function cleanupEmptyConversations(){
    try{
      Object.keys(conversations).forEach(id => {
        const c = conversations[id];
        const msgs = Array.isArray(c?.messages) ? c.messages : [];
        const title = (c?.title || '').trim();
        // Remove chats with no messages (true empty drafts)
        if(msgs.length === 0){
          // Keep only if it's the active chat AND the user is currently typing/using it
          if(id !== currentChatId){
            delete conversations[id];
          } else {
            // keep active but do not allow blank title in UI
            if(title === '') c.title = 'New chat';
          }
        } else {
          // Ensure title is not blank once messages exist
          if(title === '') c.title = inferTitleFromMessages(c);
        }
      });
    }catch(e){ console.warn('cleanupEmptyConversations failed', e); }
  }

  function saveConversations() {
    try {
      cleanupEmptyConversations();
      // Persist only chats that have content
      const toSave = {};
      Object.keys(conversations).forEach(id => {
        const c = conversations[id];
        const msgs = Array.isArray(c?.messages) ? c.messages : [];
        if(msgs.length > 0) {
          // make sure title isn't empty
          const t = (c.title || '').trim();
          if(!t) c.title = inferTitleFromMessages(c);
          toSave[id] = c;
        }
      });
      localStorage.setItem("conversations", JSON.stringify(toSave));
      localStorage.setItem("currentChatId", currentChatId || "");
      localStorage.setItem("chatCounter", String(chatCounter));
    } catch (e) {
      console.warn("Failed saving conversations", e);
    }
  }

  function loadConversations() {
    try {
      const raw = localStorage.getItem("conversations");
      if (!raw) return;
      const saved = JSON.parse(raw);
      const cc = localStorage.getItem("chatCounter");
      if (cc) chatCounter = Number(cc) || chatCounter;
      conversations = saved || {};
      scheduleRenderChatList();
      const storedActive = localStorage.getItem("currentChatId");
      if (storedActive && conversations[storedActive]) {
        // Keep in list but don't set active
      }
    } catch (e) {
      console.warn("Failed loading conversations", e);
    }
  }

  function createConversation(title) {
    const id = "chat-" + chatCounter++;
    const num = parseInt(String(id).split("-")[1], 10) || 1;
    const baseTitle = (settings && settings.language === "ar") ? "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "New chat";
    const safeTitle = (title || "").trim() || (baseTitle + " " + num);
    conversations[id] = {
      id,
      title: safeTitle,
      messages: [],
      updatedAt: Date.now(),
      archived: false,
      draft: true
    };
    scheduleRenderChatList();
    setActiveChat(id);
    saveConversations();
    return id;
  }

  function renderChatList() {
    chatListEl.innerHTML = "";

    const q = (chatSearchEl && chatSearchEl.value ? chatSearchEl.value : "").trim().toLowerCase();

    const items = Object.values(conversations)
      .filter(c => !c.archived)
      .filter(c => (Array.isArray(c.messages) && c.messages.length > 0) || c.id === currentChatId)
      // hide empty drafts by default
      .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

    items.forEach(conv => {
      if (q) {
        const t = String(conv.title || '').toLowerCase();
        if (!t.includes(q)) return;
      }
      const item = document.createElement("button");
      item.type = "button";
      item.className = "nav-item" + (conv.id === currentChatId ? " active" : "");
      item.dataset.chatId = conv.id;

      const label = document.createElement("span");
      label.textContent = conv.title || "New chat";

      const dots = document.createElement("button");
      dots.type = "button";
      dots.className = "chat-dots";
      dots.setAttribute("aria-label", "Chat options");
      dots.innerHTML = "â‹¯";

      const menu = document.createElement("div");
      menu.className = "chat-menu";
      menu.dataset.chatId = conv.id;

      const btnShare = document.createElement("button");
      btnShare.textContent = (settings.language === "ar") ? "Ù…Ø´Ø§Ø±ÙƒØ©" : "Share";
      btnShare.classList.add("share-option");

      const btnGroup = document.createElement("button");
      btnGroup.textContent = (settings.language === "ar") ? "Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©" : "Start group chat";
      btnGroup.classList.add("group-option");

      const btnRename = document.createElement("button");
      btnRename.textContent = (settings.language === "ar") ? "Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©" : "Rename";
      btnRename.classList.add("rename-option");

      const line = document.createElement("hr");
      line.style.border = "none";
      line.style.height = "1px";
      line.style.background = "var(--border-subtle)";
      line.style.margin = "4px 0";

      const btnArchive = document.createElement("button");
      btnArchive.textContent = (settings.language === "ar") ? "Ø£Ø±Ø´ÙØ©" : "Archive";
      btnArchive.classList.add("archive-option");

      const btnDelete = document.createElement("button");
      btnDelete.textContent = (settings.language === "ar") ? "Ø­Ø°Ù" : "Delete";
      btnDelete.classList.add("danger", "delete-option");

      menu.appendChild(btnShare);
      menu.appendChild(btnGroup);
      menu.appendChild(btnRename);
      menu.appendChild(line);
      menu.appendChild(btnArchive);
      menu.appendChild(btnDelete);

      item.appendChild(label);
      item.appendChild(dots);
      item.appendChild(menu);

      chatListEl.appendChild(item);
    });
  }

  function setActiveChat(chatId) {
    currentChatId = chatId;
    scheduleRenderChatList();
    renderChatMessages(chatId);
  }

  function renderChatMessages(chatId) {
    const conv = conversations[chatId];
    if (!conv) return;
    chatLogEl.innerHTML = "";
    conv.messages.forEach(msg => {
      appendMessage(msg.role, msg.text, false, false);
    });
  }

  function isArabicText(text) {
    return /[\u0600-\u06FF]/.test(text);
  }

  

  // ===== Pro helpers (safe patches) =====
  function hexToRgb(hex){
    try{
      const h = (hex||'').replace('#','').trim();
      const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const int = parseInt(full, 16);
      return { r: (int >> 16) & 255, g: (int >> 8) & 255, b: int & 255 };
    }catch(e){ return {r:0,g:0,b:0}; }
  }
  function relLuminance(rgb){
    const srgb = [rgb.r,rgb.g,rgb.b].map(v => {
      const c = v/255;
      return c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4);
    });
    return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
  }
  function contrastRatio(hex1, hex2){
    const L1 = relLuminance(hexToRgb(hex1));
    const L2 = relLuminance(hexToRgb(hex2));
    const lighter = Math.max(L1,L2);
    const darker  = Math.min(L1,L2);
    return (lighter + 0.05) / (darker + 0.05);
  }
  function setWarn(msg){
    const el = document.getElementById('fontColorWarn');
    if(!el) return;
    if(!msg){ el.textContent=''; el.classList.add('hidden'); return; }
    el.textContent = msg;
    el.classList.remove('hidden');
  }
  function makeTitleFromText(text){
    const clean = (text || '').replace(/\s+/g,' ').trim();
    if(!clean) return null;
    const words = clean.split(' ');
    const slice = words.slice(0, 7).join(' ');
    return slice.length > 50 ? slice.slice(0, 50) : slice;
  }
  let _chatListRaf = null;
  function scheduleRenderChatList(){
    if (_chatListRaf) return;
    _chatListRaf = requestAnimationFrame(() => {
      _chatListRaf = null;
      renderChatList();
    });
  }
  let _navScrollT = null;
  function bindNavListAutohide(){
    const nav = document.getElementById('chatList');
    if(!nav) return;
    nav.addEventListener('scroll', () => {
      nav.classList.add('scrolling');
      clearTimeout(_navScrollT);
      _navScrollT = setTimeout(() => nav.classList.remove('scrolling'), 700);
    }, { passive: true });
  }
  function applyFontColorByTheme(){
    const isLight = document.body.classList.contains('theme-light');
    const current = isLight ? (settings.fontColorLight || '#111827') : (settings.fontColorDark || '#ffffff');
    document.body.style.setProperty('--chat-text', current);
    document.body.style.color = current;
    const inp = document.getElementById('fontColorInput');
    if(inp) inp.value = current;

    const bg = isLight ? '#E6E3DF' : '#0b0b0f';
    const ratio = contrastRatio(current, bg);
    if (ratio < 3.0) setWarn(isLight ? 'ØªÙ†Ø¨ÙŠÙ‡: Ù„ÙˆÙ† Ø§Ù„Ø®Ø· Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§ Ù…Ù† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­.' : 'Warning: very low contrast on dark theme.');
    else if (ratio < 4.5) setWarn(isLight ? 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ù…Ù†Ø®ÙØ¶Ø› Ù‚Ø¯ ÙŠØµØ¹Ø¨ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ.' : 'Note: contrast is a bit low.');
    else setWarn('');
  }

  function toast(message){
    const el = document.getElementById('toast');
    if(!el) return;
    el.textContent = message || '';
    el.style.display = 'block';
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(() => { el.style.display = 'none'; }, 1800);
  }

function appendMessage(role, text, persist = true, animate = true) {
    if (!currentChatId) {
      createConversation("New chat");
    }
    const conv = conversations[currentChatId];
    if (persist) {
      conv.messages.push({ role, text });
      conv.updatedAt = Date.now();
      if (role === "user") {
        // First real message => lock-in title and stop treating as draft
        if (conv.draft || !(conv.title || '').trim() || conv.title === "New chat") {
          conv.title = makeTitleFromText(text) || (conv.title && conv.title.trim()) || "New chat";
          conv.draft = false;
          scheduleRenderChatList();
        }
      }
      saveConversations();
    }

    const isArabic = isArabicText(text);
    const row = document.createElement("div");
    row.className = "msg-row " + (isArabic ? "rtl" : "ltr");
    row.classList.add(role === "user" ? "user" : "bot");

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble " + (isArabic ? "rtl" : "ltr");

    const author = document.createElement("div");
    author.className = "msg-author";
    author.textContent = role === "user" ? "You" : "OAP AI";

    const body = document.createElement("div");
    bubble.appendChild(author);
    bubble.appendChild(body);
    row.appendChild(bubble);
    chatLogEl.appendChild(row);
    
    if (settings.autoScroll) {
      requestAnimationFrame(() => { chatLogEl.scrollTop = chatLogEl.scrollHeight; });
    }

    if (role === "bot" && animate) {
      // Keep the Stop button visible while the assistant is "typing" the reply (ChatGPT-like).
      typingActive = true;
      typingAbort = false;

      let i = 0;
      const full = text;
      const speed = settings.speed;

      lastTypingPromise = new Promise((resolve) => {
        function done() {
          typingActive = false;
          resolve();
        }
        function typeNext() {
          if (typingAbort) {
            done();
            return;
          }
          body.textContent = full.slice(0, i);
          i++;
          if (settings.autoScroll) {
            chatLogEl.scrollTop = chatLogEl.scrollHeight;
          }
          if (i <= full.length && !typingAbort) {
            setTimeout(typeNext, speed);
          } else {
            done();
          }
        }
        typeNext();
      });
    } else {
      body.textContent = text;
      lastTypingPromise = Promise.resolve();
    }

    return row;
  }

  function showThinking(lastUserText) {
    if (thinkingRow) return;
    const isArabic = isArabicText(lastUserText);
    thinkingRow = document.createElement("div");
    thinkingRow.className = "msg-row " + (isArabic ? "rtl" : "ltr") + " bot";
    const bubble = document.createElement("div");
    bubble.className = "msg-bubble " + (isArabic ? "rtl" : "ltr");
    const author = document.createElement("div");
    author.className = "msg-author";
    author.textContent = "OAP AI";
    const body = document.createElement("div");
    const spanText = document.createElement("span");
    spanText.className = "thinking-text";
    spanText.textContent = "I'm thinking to give you the best answers";
    const dots = document.createElement("div");
    dots.className = "thinking-dots";
    dots.innerHTML = "<span></span><span></span><span></span>";
    body.appendChild(spanText);
    body.appendChild(dots);
    bubble.appendChild(author);
    bubble.appendChild(body);
    thinkingRow.appendChild(bubble);
    chatLogEl.appendChild(thinkingRow);
    if (settings.autoScroll) {
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }
  }

  function clearThinking() {
    if (thinkingRow && thinkingRow.parentNode) {
      thinkingRow.parentNode.removeChild(thinkingRow);
    }
    thinkingRow = null;
  }

  function setSendMode(mode) {
    if (mode === "stop") {
      sendBtn.title = (settings.language === "ar" ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" : "Stop generating");
      sendBtn.dataset.mode = "stop";
      sendBtn.innerHTML = "<svg viewBox='0 0 24 24' aria-hidden='true'><rect x='7' y='7' width='10' height='10' rx='1.6' fill='#000000'/></svg>";
      sendBtn.disabled = false;
      sendBtn.classList.add("ready");
      sendBtn.classList.add("stop-mode");
    } else {
      sendBtn.title = (settings.language === "ar" ? "Ø¥Ø±Ø³Ø§Ù„" : "Send");
      sendBtn.dataset.mode = "send";
      sendBtn.innerHTML =
        "<svg viewBox='0 0 24 24' fill='none'><path d='M4 4L20 12L4 20L7 12L4 4Z' stroke='currentColor' stroke-width='1.7' stroke-linejoin='round'/></svg>";
      sendBtn.classList.remove("stop-mode");
      refreshSendButtonState();
    }
  }

  function refreshSendButtonState() {
    // Keep the Stop button clickable while a response is generating/typing
    const mode = sendBtn.dataset.mode || "send";
    if (mode === "stop" || abortController || typingActive) {
      sendBtn.disabled = false;
      sendBtn.classList.add("ready");
      return;
    }

    const hasText = userInputEl.value.trim().length > 0;
    sendBtn.disabled = !hasText;
    if (hasText) {
      sendBtn.classList.add("ready");
    } else {
      sendBtn.classList.remove("ready");
    }
  }

  async function sendMessage() {
    const text = userInputEl.value.trim();
    if (!text) return;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ø¬Ø§Ø±Ù Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù„Ø§ Ù†Ø¨Ø¯Ø£ Ø·Ù„Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
    if (abortController) {
      return;
    }

    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ù„Ø¨)
    setSendMode("stop");

    if (!currentChatId) {
      createConversation("New chat");
    }

    appendMessage("user", text, true);
    userInputEl.value = "";
    autoResizeTextarea();
    refreshSendButtonState();

    showThinking(text);
    abortController = new AbortController();

    try {
      const data = await sendToNXS(text);
      clearThinking();
      abortController = null;

      const reply =
        (data && (data.reply || data.answer)) ||
        (settings.language === "ar"
          ? "âš ï¸ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø®Ø§Ø¯Ù… NXS. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
          : "âš ï¸ Could not get a reply from the NXS server. Please try again.");

      appendMessage("bot", reply, true, true);
    } catch (err) {
      console.error(err);
      clearThinking();

      if (err.name === "AbortError") {
        const msg =
          settings.language === "ar"
            ? "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ."
            : "Generation was stopped at your request.";
        appendMessage("bot", msg, true, false);
      } else {
        const msg =
          settings.language === "ar"
            ? "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… NXS. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø§Øª."
            : "âš ï¸ An error occurred while contacting the NXS server. Please try again.";
        appendMessage("bot", msg, true, false);
      }

      abortController = null;
    } finally {
      try { await lastTypingPromise; } catch (e) {}
      setSendMode("send");
      userInputEl.focus();
    }
  }

  function adjustPromptShape() {
    if (!promptCardEl) return;
    const h = promptCardEl.offsetHeight;
    let radius;
    if (h <= 90) {
      radius = 24;
    } else if (h <= 140) {
      radius = 18;
    } else {
      radius = 16;
    }
    promptCardEl.style.borderRadius = radius + "px";
  }

  function autoResizeTextarea() {
    userInputEl.style.height = "auto";
    const scrollH = userInputEl.scrollHeight;
    const newH = Math.min(scrollH, MAX_TEXTAREA_HEIGHT);
    userInputEl.style.height = newH + "px";
    userInputEl.style.overflowY = scrollH > MAX_TEXTAREA_HEIGHT ? "auto" : "hidden";
    adjustPromptShape();
  }

  userInputEl.addEventListener("input", () => {
    autoResizeTextarea();
    refreshSendButtonState();
  });

  // ===== Event Listeners =====
  sendBtn.addEventListener("click", () => {
    const mode = sendBtn.dataset.mode || "send";
    // Allow stopping even if the input is empty (because we clear it after sending)
    if (mode === "stop") {
      // Stop streaming/request (if any)
      if (abortController) {
        abortController.abort();
        abortController = null;
      }
      // Stop the typewriter animation (if it is running)
      if (typingActive) {
        typingAbort = true;
      }
      setSendMode("send");
      clearThinking();
      return;
    }

    const now = Date.now();
    const raw = (userInputEl.value || "").trim();
    if (!raw) { return; }
    if ((now - _lastSendAt) < 450 && raw === _lastSendText) { return; }
    _lastSendAt = now; _lastSendText = raw;

    sendMessage();
  });

  userInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      const mode = sendBtn.dataset.mode || "send";
      if (mode === "stop") {
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        if (typingActive) {
          typingAbort = true;
        }
        setSendMode("send");
        clearThinking();
      } else {
        sendMessage();
      }
    }
  });

  newChatSidebarBtn.addEventListener("click", () => {
    createConversation("New chat");
    chatLogEl.innerHTML = "";
    userInputEl.focus();
  });

  plusBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    plusMenu.classList.toggle("open");
  });

  document.addEventListener("click", () => {
    plusMenu.classList.remove("open");
  });

  plusMenu.addEventListener("click", (e) => {
    e.stopPropagation();
  });

  menuNewChat.addEventListener("click", () => {
    plusMenu.classList.remove("open");
    createConversation("New chat");
    chatLogEl.innerHTML = "";
    userInputEl.focus();
  });

  menuUpload.addEventListener("click", () => {
    plusMenu.classList.remove("open");
    fileInput.click();
  });

  fileInput.addEventListener("change", () => {
    const files = Array.from(fileInput.files || []);
    if (!files.length) return;
    const names = files.map(f => f.name).join(", ");
    appendMessage("user", "Attached files: " + names, true, false);
    fileInput.value = "";
  });

  // Settings menu toggle
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsMenu = document.getElementById("settingsMenu");

  settingsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = settingsMenu.style.display === "block";
    settingsMenu.style.display = open ? "none" : "block";
    settingsMenu.setAttribute('aria-hidden', open ? 'true' : 'false');
  });

  document.addEventListener("click", () => {
    settingsMenu.style.display = "none";
    settingsMenu.setAttribute('aria-hidden', 'true');
  });

  settingsMenu.addEventListener("click", (e) => {
    e.stopPropagation();
  });

  
  /* ===== PATCH: smart chat-menu positioning ===== */
  function placeChatMenu(dotsEl, menuEl){
    if(!dotsEl || !menuEl) return;
    // make menu fixed to avoid clipping inside scroll container
    menuEl.style.position = "fixed";
    menuEl.style.right = "auto";
    menuEl.style.left = "0px";
    menuEl.style.top = "0px";

    // temporarily show to measure
    const wasOpen = menuEl.classList.contains("open");
    if(!wasOpen) menuEl.classList.add("open");
    const rect = dotsEl.getBoundingClientRect();
    const mw = menuEl.offsetWidth || 180;
    const mh = menuEl.offsetHeight || 220;

    const pad = 8;
    let left = rect.right - mw; // align right edges
    left = Math.max(pad, Math.min(left, window.innerWidth - mw - pad));

    // default open downward
    let top = rect.bottom + 6;
    // if overflow bottom, open upward
    if(top + mh > window.innerHeight - pad){
      top = rect.top - mh - 6;
    }
    top = Math.max(pad, Math.min(top, window.innerHeight - mh - pad));

    menuEl.style.left = left + "px";
    menuEl.style.top  = top + "px";

    if(!wasOpen) menuEl.classList.remove("open");
  }

// Chat menu logic
  document.addEventListener("click", (e) => {
    const dots = e.target.closest(".chat-dots");
    if (dots) {
      e.stopPropagation();
      const nav = dots.closest(".nav-item");
      const menu = nav.querySelector(".chat-menu");
      document.querySelectorAll(".chat-menu.open").forEach(m => {
        if (m !== menu) m.classList.remove("open");
      });
      const willOpen = !menu.classList.contains("open");
      menu.classList.toggle("open");
      if (willOpen) { placeChatMenu(dots, menu); }
      return;
    }

    const renameBtn = e.target.closest(".rename-option");
    if (renameBtn) {
      const menu = renameBtn.closest(".chat-menu");
      const chatId = menu.dataset.chatId;
      window.__chatToRename = chatId;

      const modal = document.getElementById("renameModal");
      const input = document.getElementById("renameInput");
      input.value = conversations[chatId].title;
      modal.style.display = "flex";
      return;
    }

    
    const shareBtn = e.target.closest(".share-option");
    if (shareBtn) {
      const menu = shareBtn.closest(".chat-menu");
      const chatId = menu.dataset.chatId;
      try {
        const payload = conversations[chatId] || {};
        const txt = JSON.stringify(payload, null, 2);
        navigator.clipboard?.writeText(txt);
        toast(settings.language === "ar" ? "ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©." : "Chat data copied.");
      } catch (e) {
        toast(settings.language === "ar" ? "ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®." : "Copy failed.");
      }
      menu.classList.remove("open");
      return;
    }

    const groupBtn = e.target.closest(".group-option");
    if (groupBtn) {
      toast(settings.language === "ar" ? "Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ù‹Ø§." : "Group chat is coming soon.");
      const menu = groupBtn.closest(".chat-menu");
      menu.classList.remove("open");
      return;
    }

    const archiveBtn = e.target.closest(".archive-option");
    if (archiveBtn) {
      const menu = archiveBtn.closest(".chat-menu");
      const chatId = menu.dataset.chatId;
      if (conversations[chatId]) {
        conversations[chatId].archived = true;
        saveConversations();
        scheduleRenderChatList();
        toast(settings.language === "ar" ? "ØªÙ…Øª Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©." : "Chat archived.");
        if (currentChatId === chatId) {
          currentChatId = null;
          chatLogEl.innerHTML = "";
        }
      }
      menu.classList.remove("open");
      return;
    }

    const deleteBtn = e.target.closest(".delete-option");
    if (deleteBtn) {
      const menu = deleteBtn.closest(".chat-menu");
      const chatId = menu.dataset.chatId;
      window.__chatToDelete = chatId;

      const modal = document.getElementById("deleteConfirmModal");
      modal.style.display = "flex";
      return;
    }

    document.querySelectorAll(".chat-menu.open").forEach(m => m.classList.remove("open"));
  });

  // Chat selection
  chatListEl.addEventListener("click", (e) => {
    if (e.target.closest(".chat-dots")) return;
    
    const btn = e.target.closest(".nav-item");
    if (!btn) return;
    const chatId = btn.dataset.chatId;
    if (chatId && conversations[chatId]) {
      setActiveChat(chatId);
    }
  });

  // Modals
  const deleteModal = document.getElementById("deleteConfirmModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const confirmDelete = document.getElementById("confirmDelete");

  cancelDelete.addEventListener("click", (e) => {
    e.stopPropagation();
    deleteModal.style.display = "none";
    window.__chatToDelete = null;
  });

  confirmDelete.addEventListener("click", (e) => {
    e.stopPropagation();
    const chatId = window.__chatToDelete;
    if (chatId && conversations[chatId]) {
      delete conversations[chatId];
      if (currentChatId === chatId) {
        chatLogEl.innerHTML = "";
        currentChatId = null;
      }
      saveConversations();
      scheduleRenderChatList();
    }
    deleteModal.style.display = "none";
    window.__chatToDelete = null;
  });

  const renameModal = document.getElementById("renameModal");
  const cancelRename = document.getElementById("cancelRename");
  const confirmRename = document.getElementById("confirmRename");
  const renameInput = document.getElementById("renameInput");

  cancelRename.addEventListener("click", (e) => {
    e.stopPropagation();
    renameModal.style.display = "none";
    window.__chatToRename = null;
  });

  confirmRename.addEventListener("click", (e) => {
    e.stopPropagation();
    const chatId = window.__chatToRename;
    const newTitle = renameInput.value.trim();

    if (chatId && newTitle.length > 0) {
      conversations[chatId].title = newTitle;
      saveConversations();
      scheduleRenderChatList();
    }
    renameModal.style.display = "none";
    window.__chatToRename = null;
  });

  // Clear all modal
  const clearAllModal = document.getElementById("clearAllModal");
  const cancelClearAll = document.getElementById("cancelClearAll");
  const confirmClearAll = document.getElementById("confirmClearAll");

  cancelClearAll.addEventListener("click", () => {
    clearAllModal.style.display = "none";
  });

  confirmClearAll.addEventListener("click", () => {
    localStorage.clear();
    location.reload();
  });

  // Close modals on outside click
  [deleteModal, renameModal, clearAllModal].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // ===== Initialize =====
  loadSettings();
  applyLanguage();
  bindNavListAutohide();
  loadConversations();
  if (Object.keys(conversations).length === 0) {
    createConversation("New chat");
  } else {
    // restore last active chat if any
    const storedActive = localStorage.getItem("currentChatId");
    if (storedActive && conversations[storedActive]) setActiveChat(storedActive);
    else {
      // pick most recent
      const latest = Object.values(conversations).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))[0];
      if (latest) setActiveChat(latest.id);
    }
  }
  autoResizeTextarea();
  window.addEventListener("resize", adjustPromptShape);
  window.addEventListener("beforeunload", saveConversations);
  setSendMode("send");
  userInputEl.focus();
</script>

</body>
</html>
