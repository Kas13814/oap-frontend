<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OAP • SGS Flight Delay Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =========================
       OAP Dashboard (Single file)
       - نفس تصميم الهولو (Uiverse)
       - عند التفعيل: KPI + Charts + Table
       - مصدر البيانات: API (افتراضي) أو Supabase (اختياري) أو Demo
       ========================= */

    :root {
      --bg: #02040a;
      --glass: rgba(8, 18, 35, 0.60);
      --glass2: rgba(8, 18, 35, 0.42);
      --stroke: rgba(0, 162, 255, 0.34);
      --stroke2: rgba(0, 255, 166, 0.26);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.56);
      --ok: rgba(0, 255, 166, 0.95);
      --warn: rgba(255, 138, 0, 0.95);
      --bad: rgba(255, 64, 64, 0.95);
      --shadow: 0 0 28px rgba(0, 162, 255, 0.08);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      overflow: hidden;
      min-height: 100vh;
      font-family: "Tajawal", "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 55% 20%, rgba(0, 162, 255, 0.11), rgba(0, 0, 0, 0) 55%),
        radial-gradient(900px 700px at 40% 78%, rgba(0, 255, 136, 0.08), rgba(0, 0, 0, 0) 60%),
        var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Top-left brand (يبقى على اليسار حتى مع RTL) */
    .oap-brand {
      position: fixed;
      top: 16px;
      left: 16px;
      right: auto;
      z-index: 2000;
      padding: 9px 12px 9px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0, 24, 55, 0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      user-select: none;
      pointer-events: none;
      box-shadow: 0 0 18px rgba(0, 162, 255, 0.18);
    }

    /* ============ Dashboard shell ============ */
    .dashboard {
      position: fixed;
      inset: 0;
      z-index: 1500;
      padding: 110px 18px 18px;
      overflow: auto;
      opacity: 0;
      transform: translateY(16px);
      pointer-events: none;
      transition: opacity 520ms ease, transform 520ms ease;
    }
    body.dash-active .dashboard {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* يرفع الهولو للأعلى عند التفعيل */
    body.dash-active .checkbox-container {
      position: fixed;
      top: 56px;
      left: 50%;
      transform: translateX(-50%) scale(0.86);
      z-index: 1999;
      margin: 0;
      transition: transform 520ms ease, top 520ms ease, left 520ms ease;
    }

    .dash-wrap {
      max-width: 1220px;
      margin: 0 auto;
    }

    .dash-header {
      display: grid;
      gap: 12px;
      margin-bottom: 14px;
    }

    .hero {
      border-radius: 22px;
      border: 1px solid rgba(0, 162, 255, 0.22);
      background: linear-gradient(180deg, rgba(0, 162, 255, 0.08), rgba(0, 0, 0, 0.02));
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .hero::before {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(600px 180px at 40% 0%, rgba(0, 255, 166, 0.10), transparent 60%),
                  radial-gradient(540px 160px at 85% 30%, rgba(0, 162, 255, 0.14), transparent 62%);
      opacity: 0.9;
      pointer-events: none;
    }
    .hero-inner {
      position: relative;
      padding: 16px 16px 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
      justify-content: space-between;
    }

    .title-block {
      display: grid;
      gap: 6px;
      min-width: 260px;
    }
    .title-block h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .title-block .sub {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .meta-line {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .meta-pill {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      white-space: nowrap;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .ctrl {
      display: grid;
      gap: 6px;
      min-width: 170px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0, 162, 255, 0.18);
      background: var(--glass2);
      box-shadow: 0 0 16px rgba(0, 162, 255, 0.05);
    }
    .ctrl label {
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      font-weight: 800;
    }
    .ctrl input, .ctrl select {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      outline: none;
      font-family: inherit;
      font-weight: 700;
    }
    .ctrl input:focus, .ctrl select:focus {
      border-color: rgba(0, 255, 166, 0.35);
      box-shadow: 0 0 0 3px rgba(0, 255, 166, 0.10);
    }

    .btn {
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(0, 255, 166, 0.28);
      background: rgba(0, 255, 166, 0.08);
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 0 16px rgba(0, 255, 166, 0.08);
      transition: transform 180ms ease, background 180ms ease, border-color 180ms ease;
      font-family: inherit;
      letter-spacing: 0.2px;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(0, 255, 166, 0.11); }
    .btn:active { transform: translateY(0px); }

    .btn.secondary {
      border-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 0 16px rgba(0,0,0,0.10);
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid rgba(0, 162, 255, 0.20);
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      opacity: 0;
      transform: translateY(22px) scale(0.985);
    }

    body.dash-active .card {
      animation: deploy 640ms cubic-bezier(.2,.9,.2,1) forwards;
    }

    /* stagger */
    .card[data-i="1"] { animation-delay: 60ms; }
    .card[data-i="2"] { animation-delay: 110ms; }
    .card[data-i="3"] { animation-delay: 160ms; }
    .card[data-i="4"] { animation-delay: 210ms; }
    .card[data-i="5"] { animation-delay: 260ms; }
    .card[data-i="6"] { animation-delay: 310ms; }
    .card[data-i="7"] { animation-delay: 360ms; }
    .card[data-i="8"] { animation-delay: 410ms; }
    .card[data-i="9"] { animation-delay: 460ms; }

    @keyframes deploy {
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .card .hd {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .card .hd .t {
      color: var(--text);
      font-weight: 900;
      font-size: 14px;
    }
    .card .hd .s {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      font-weight: 800;
    }
    .card .bd {
      padding: 14px;
    }

    .kpi {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .kpi .v {
      font-size: 30px;
      font-weight: 900;
      color: var(--text);
      letter-spacing: 0.3px;
    }
    .kpi .m {
      display: grid;
      gap: 4px;
    }
    .kpi .m .label {
      font-size: 13px;
      color: rgba(255,255,255,0.85);
      font-weight: 900;
    }
    .kpi .m .hint {
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 255, 166, 0.22);
      background: rgba(0, 255, 166, 0.07);
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }

    .chartBox {
      position: relative;
      height: 280px;
    }
    .chartBox.tall { height: 330px; }
    canvas { display: block; width: 100% !important; height: 100% !important; }

    /* Table */
    .table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
    }
    .table th, .table td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 13px;
      color: rgba(255,255,255,0.88);
      text-align: right;
      vertical-align: middle;
    }
    .table th {
      color: rgba(255,255,255,0.75);
      font-weight: 900;
      background: rgba(0,0,0,0.16);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .table td.muted { color: rgba(255,255,255,0.62); }
    .table tr:hover td {
      background: rgba(0, 255, 166, 0.04);
    }

    /* Loading + Toast */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(255,255,255,0.78);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.2px;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(0, 255, 166, 0.8);
      animation: pulse 900ms ease infinite;
    }
    .dot:nth-child(2) { animation-delay: 120ms; }
    .dot:nth-child(3) { animation-delay: 240ms; }
    @keyframes pulse {
      0%, 100% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 240ms ease, transform 240ms ease;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 0 24px rgba(0,0,0,0.35);
      max-width: calc(100vw - 24px);
      text-align: center;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 1080px) {
      .dashboard { padding-top: 128px; }
      .chartBox.tall { height: 320px; }
    }
    @media (max-width: 860px) {
      .ctrl { min-width: 150px; }
      .kpi .v { font-size: 26px; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    /* ===== Inject original Uiverse CSS (same holo design) ===== */
/* From Uiverse.io by reglobby */ 
.stars-container {
  position: absolute;
  width: 100%;
  height: 100%;
  perspective: 500px;
  transform-style: preserve-3d;
}

.star-layer {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  opacity: 0.8;
}

.star-layer:nth-child(1) {
  transform: translateZ(-50px);
  animation: star-drift 150s linear infinite;
}

.star-layer:nth-child(2) {
  transform: translateZ(-100px);
  animation: star-drift 200s linear infinite reverse;
  opacity: 0.6;
}

.star-layer:nth-child(3) {
  transform: translateZ(-200px);
  animation: star-drift 250s linear infinite;
  opacity: 0.4;
}

@keyframes star-drift {
  0% {
    transform: translateZ(-50px) translateY(0);
  }
  100% {
    transform: translateZ(-50px) translateY(100%);
  }
}

.star-layer::before,
.star-layer::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
}

.star-layer:nth-child(1)::before {
  background-image: radial-gradient(1px 1px at 10% 10%, white 100%, transparent),
    radial-gradient(1px 1px at 20% 20%, white 100%, transparent),
    radial-gradient(2px 2px at 30% 30%, white 100%, transparent),
    radial-gradient(1px 1px at 40% 40%, white 100%, transparent),
    radial-gradient(2px 2px at 50% 50%, white 100%, transparent),
    radial-gradient(1px 1px at 60% 60%, white 100%, transparent),
    radial-gradient(2px 2px at 70% 70%, white 100%, transparent),
    radial-gradient(1px 1px at 80% 80%, white 100%, transparent),
    radial-gradient(2px 2px at 90% 90%, white 100%, transparent),
    radial-gradient(1px 1px at 15% 85%, white 100%, transparent);
}

.nebula {
  position: absolute;
  width: 120%;
  height: 120%;
  top: -10%;
  left: -10%;
  background: radial-gradient(
      ellipse at 30% 30%,
      rgba(63, 0, 113, 0.3) 0%,
      rgba(63, 0, 113, 0) 70%
    ),
    radial-gradient(
      ellipse at 70% 60%,
      rgba(0, 113, 167, 0.3) 0%,
      rgba(0, 113, 167, 0) 70%
    ),
    radial-gradient(
      ellipse at 50% 50%,
      rgba(167, 0, 157, 0.2) 0%,
      rgba(167, 0, 157, 0) 70%
    );
  filter: blur(30px);
  opacity: 0.5;
  animation: nebula-shift 30s infinite alternate ease-in-out;
}

@keyframes nebula-shift {
  0% {
    transform: scale(1) rotate(0deg);
    opacity: 0.3;
  }
  50% {
    opacity: 0.5;
  }
  100% {
    transform: scale(1.2) rotate(5deg);
    opacity: 0.4;
  }
}

.grid-plane {
  position: absolute;
  width: 200%;
  height: 200%;
  top: -50%;
  left: -50%;
  background-image: linear-gradient(
      rgba(0, 162, 255, 0.15) 1px,
      transparent 1px
    ),
    linear-gradient(90deg, rgba(0, 162, 255, 0.15) 1px, transparent 1px);
  background-size: 40px 40px;
  transform: perspective(500px) rotateX(60deg);
  transform-origin: center;
  animation: grid-move 20s linear infinite;
  opacity: 0.3;
}

@keyframes grid-move {
  0% {
    transform: perspective(500px) rotateX(60deg) translateY(0);
  }
  100% {
    transform: perspective(500px) rotateX(60deg) translateY(40px);
  }
}

.checkbox-container {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 300px;
  height: 300px;
  z-index: 10;
}

/* Скрываем стандартный чекбокс */
.holo-checkbox-input {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.holo-checkbox {
  position: relative;
  width: 80px;
  height: 80px;
  cursor: pointer;
  transform-style: preserve-3d;
  perspective: 1000px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.holo-box {
  position: relative;
  width: 100%;
  height: 100%;
  border: 2px solid rgba(0, 162, 255, 0.7);
  border-radius: 12px;
  background-color: rgba(0, 24, 55, 0.5);
  box-shadow:
    0 0 10px rgba(0, 162, 255, 0.5),
    inset 0 0 15px rgba(0, 162, 255, 0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  transition: all 0.3s ease;
  transform-style: preserve-3d;
}

.holo-inner {
  position: absolute;
  width: 30%;
  height: 30%;
  background-color: rgba(0, 162, 255, 0.5);
  border-radius: 4px;
  opacity: 0;
  transform: scale(0) rotate(45deg);
  transition: all 0.3s ease;
  box-shadow: 0 0 15px rgba(0, 162, 255, 0.8);
}

.scan-effect {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 2px;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(0, 162, 255, 0.8),
    transparent
  );
  animation: scan-off 4s infinite;
  opacity: 0.3;
  transition: all 0.3s ease;
}

@keyframes scan-off {
  0% {
    left: -100%;
    opacity: 0.3;
  }
  100% {
    left: 100%;
    opacity: 0.3;
  }
}

@keyframes scan-on {
  0% {
    left: -100%;
    opacity: 1;
  }
  100% {
    left: 100%;
    opacity: 1;
  }
}

.holo-checkbox-input:checked + .holo-checkbox .holo-box {
  border-color: rgba(0, 255, 136, 0.7);
  box-shadow:
    0 0 10px rgba(0, 255, 136, 0.6),
    inset 0 0 15px rgba(0, 255, 136, 0.4);
}

.holo-checkbox-input:checked + .holo-checkbox .holo-inner {
  background-color: rgba(0, 255, 136, 0.7);
  box-shadow: 0 0 15px rgba(0, 255, 136, 1);
  opacity: 1;
  transform: scale(1) rotate(45deg);
}

.holo-checkbox-input:checked + .holo-checkbox .scan-effect {
  animation: scan-on 2s infinite;
  opacity: 1;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(0, 255, 136, 0.8),
    transparent
  );
}

.holo-glow {
  position: absolute;
  width: 200%;
  height: 200%;
  left: -50%;
  top: -50%;
  background: radial-gradient(
    ellipse at center,
    rgba(0, 162, 255, 0.2) 0%,
    rgba(0, 162, 255, 0.1) 40%,
    rgba(0, 0, 0, 0) 70%
  );
  pointer-events: none;
  filter: blur(10px);
  opacity: 0.5;
  z-index: -1;
  animation: glow-pulse 4s infinite alternate;
  transition: all 0.5s ease;
}

@keyframes glow-pulse {
  0% {
    opacity: 0.3;
    filter: blur(10px) brightness(0.8);
  }
  100% {
    opacity: 0.6;
    filter: blur(15px) brightness(1.2);
  }
}

.holo-checkbox-input:checked + .holo-checkbox .holo-glow {
  background: radial-gradient(
    ellipse at center,
    rgba(0, 255, 136, 0.2) 0%,
    rgba(0, 255, 136, 0.1) 40%,
    rgba(0, 0, 0, 0) 70%
  );
  animation: active-glow-pulse 2s infinite alternate;
}

@keyframes active-glow-pulse {
  0% {
    opacity: 0.4;
    filter: blur(10px) brightness(1);
  }
  100% {
    opacity: 0.8;
    filter: blur(20px) brightness(1.5);
  }
}

.corner-accent {
  position: absolute;
  width: 15px;
  height: 15px;
  border-style: solid;
  border-width: 2px;
  border-color: rgba(0, 162, 255, 0.5);
  transition: all 0.3s ease;
}

.corner-accent:nth-child(1) {
  top: -5px;
  left: -5px;
  border-right: none;
  border-bottom: none;
  border-radius: 5px 0 0 0;
}

.corner-accent:nth-child(2) {
  top: -5px;
  right: -5px;
  border-left: none;
  border-bottom: none;
  border-radius: 0 5px 0 0;
}

.corner-accent:nth-child(3) {
  bottom: -5px;
  left: -5px;
  border-right: none;
  border-top: none;
  border-radius: 0 0 0 5px;
}

.corner-accent:nth-child(4) {
  bottom: -5px;
  right: -5px;
  border-left: none;
  border-top: none;
  border-radius: 0 0 5px 0;
}

.holo-checkbox-input:checked + .holo-checkbox .corner-accent {
  width: 20px;
  height: 20px;
  border-color: rgba(0, 255, 136, 0.7);
}

.status-text {
  margin-top: 30px;
  font-size: 16px;
  font-weight: 500;
  color: rgba(0, 162, 255, 0.8);
  text-shadow: 0 0 5px rgba(0, 162, 255, 0.5);
  position: relative;
  transition: all 0.3s ease;
}

.status-text::before {
  content: "SYSTEM DEACTIVATED";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.holo-checkbox-input:checked ~ .status-text::before {
  content: "SYSTEM ACTIVATED";
  color: rgba(0, 255, 136, 0.8);
  text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
}

.activation-rings {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.activation-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40%;
  height: 40%;
  border: 1px solid rgba(0, 255, 136, 0);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  opacity: 0;
  transition: all 0.3s ease;
}

.holo-checkbox-input:checked + .holo-checkbox .activation-ring {
  animation: ring-expand 2s ease-out forwards;
  border-color: rgba(0, 255, 136, 0.7);
}

.holo-checkbox-input:checked + .holo-checkbox .activation-ring:nth-child(1) {
  animation-delay: 0s;
}

.holo-checkbox-input:checked + .holo-checkbox .activation-ring:nth-child(2) {
  animation-delay: 0.3s;
}

.holo-checkbox-input:checked + .holo-checkbox .activation-ring:nth-child(3) {
  animation-delay: 0.6s;
}

@keyframes ring-expand {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(2.5);
    opacity: 0;
  }
}

.holo-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.holo-particle {
  position: absolute;
  background-color: rgba(0, 162, 255, 0.7);
  border-radius: 50%;
  width: 3px;
  height: 3px;
  opacity: 0;
  filter: blur(1px);
  transition: all 0.3s ease;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle {
  background-color: rgba(0, 255, 136, 0.7);
  animation: particle-float 3s infinite ease-in-out;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(1) {
  top: 20%;
  left: 30%;
  animation-delay: 0.1s;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(2) {
  top: 70%;
  left: 20%;
  animation-delay: 0.7s;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(3) {
  top: 40%;
  left: 80%;
  animation-delay: 1.3s;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(4) {
  top: 60%;
  left: 60%;
  animation-delay: 1.9s;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(5) {
  top: 30%;
  left: 45%;
  animation-delay: 2.5s;
}

.holo-checkbox-input:checked + .holo-checkbox .holo-particle:nth-child(6) {
  top: 60%;
  left: 40%;
  animation-delay: 3.1s;
}

@keyframes particle-float {
  0% {
    transform: translateY(0) scale(1);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  80% {
    opacity: 1;
  }
  100% {
    transform: translateY(-20px) scale(0);
    opacity: 0;
  }
}

.cube-transform {
  position: absolute;
  width: 30%;
  height: 30%;
  transform-style: preserve-3d;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.cube-face {
  position: absolute;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 162, 255, 0.3);
  border: 1px solid rgba(0, 162, 255, 0.5);
  box-shadow: 0 0 5px rgba(0, 162, 255, 0.3);
  transition: all 0.3s ease;
}

.holo-checkbox-input:checked + .holo-checkbox .cube-transform {
  opacity: 1;
  animation: cube-rotate 5s infinite linear;
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face {
  background-color: rgba(0, 255, 136, 0.3);
  border-color: rgba(0, 255, 136, 0.5);
  box-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(1) {
  transform: translateZ(15px);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(2) {
  transform: rotateY(180deg) translateZ(15px);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(3) {
  transform: rotateY(90deg) translateZ(15px);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(4) {
  transform: rotateY(-90deg) translateZ(15px);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(5) {
  transform: rotateX(90deg) translateZ(15px);
}

.holo-checkbox-input:checked + .holo-checkbox .cube-face:nth-child(6) {
  transform: rotateX(-90deg) translateZ(15px);
}

@keyframes cube-rotate {
  0% {
    transform: rotateX(0) rotateY(0) rotateZ(0);
  }
  100% {
    transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg);
  }
}

.frequency-spectrum {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  height: 40px;
  width: 260px;
  margin-top: 30px;
  gap: 3px;
}

.frequency-bar {
  width: 4px;
  height: 5px;
  background: rgba(0, 162, 255, 0.5);
  border-radius: 2px 2px 0 0;
  transition:
    height 0.3s ease,
    background 0.3s ease;
}

.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar {
  background: rgba(0, 255, 136, 0.5);
  animation: frequency-animation 1.5s infinite ease;
}

.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(1) {
  animation-delay: 0.1s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(2) {
  animation-delay: 0.2s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(3) {
  animation-delay: 0.1s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(4) {
  animation-delay: 0.3s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(5) {
  animation-delay: 0.5s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(6) {
  animation-delay: 0.2s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(7) {
  animation-delay: 0.4s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(8) {
  animation-delay: 0.1s;
}
.holo-checkbox-input:checked ~ .frequency-spectrum .frequency-bar:nth-child(9) {
  animation-delay: 0.3s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(10) {
  animation-delay: 0.2s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(11) {
  animation-delay: 0.5s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(12) {
  animation-delay: 0.3s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(13) {
  animation-delay: 0.1s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(14) {
  animation-delay: 0.4s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(15) {
  animation-delay: 0.2s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(16) {
  animation-delay: 0.3s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(17) {
  animation-delay: 0.1s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(18) {
  animation-delay: 0.5s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(19) {
  animation-delay: 0.2s;
}
.holo-checkbox-input:checked
  ~ .frequency-spectrum
  .frequency-bar:nth-child(20) {
  animation-delay: 0.4s;
}

@keyframes frequency-animation {
  0% {
    height: 5px;
  }
  50% {
    height: 35px;
  }
  100% {
    height: 5px;
  }
}

.holo-label {
  position: absolute;
  bottom: -60px;
  font-size: 12px;
  font-weight: 700;
  color: rgba(0, 162, 255, 0.8);
  letter-spacing: 1px;
  text-shadow: 0 0 5px rgba(0, 162, 255, 0.5);
  transition: all 0.3s ease;
}

.holo-checkbox-input:checked ~ .holo-label {
  color: rgba(0, 255, 136, 0.8);
  text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
}

.data-chips {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
  color: white;
}

.data-chip {
  position: absolute;
  padding: 5px 8px;
  background-color: rgba(0, 24, 55, 0.7);
  border: 1px solid rgba(0, 162, 255, 0.5);
  border-radius: 4px;
  font-size: 10px;
  opacity: 0;
  transform: scale(0);
  transition: all 0.3s ease;
}

.holo-checkbox-input:checked ~ .data-chips .data-chip {
  animation: chip-appear 0.5s ease forwards;
  border-color: rgba(0, 255, 136, 0.5);
}

@keyframes chip-appear {
  0% {
    opacity: 0;
    transform: scale(0);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.data-chip:nth-child(1) {
  top: -60px;
  left: 50px;
  animation-delay: 0.5s;
}

.data-chip:nth-child(2) {
  top: 40px;
  left: -120px;
  animation-delay: 1.2s;
}

.data-chip:nth-child(3) {
  top: 120px;
  left: 60px;
  animation-delay: 1.8s;
}

.data-chip:nth-child(4) {
  top: 20px;
  left: 120px;
  animation-delay: 2.3s;
}

  </style>
</head>

<body>
  <div class="oap-brand">OAP</div>

  <!-- From Uiverse.io by reglobby -->
  <div class="grid-plane"></div>
  <div class="stars-container" aria-hidden="true">
    <div class="star-layer"></div>
    <div class="star-layer"></div>
    <div class="star-layer"></div>
  </div>

  <!-- Activator (same design) -->
  <div class="checkbox-container" id="activator">
    <input class="holo-checkbox-input" id="holo-check" type="checkbox" />
    <label class="holo-checkbox" for="holo-check">
      <div class="holo-box">
        <div class="holo-inner"></div>
        <div class="scan-effect"></div>

        <div class="holo-particles">
          <div class="holo-particle"></div>
          <div class="holo-particle"></div>
          <div class="holo-particle"></div>
          <div class="holo-particle"></div>
          <div class="holo-particle"></div>
          <div class="holo-particle"></div>
        </div>

        <div class="activation-rings">
          <div class="activation-ring"></div>
          <div class="activation-ring"></div>
          <div class="activation-ring"></div>
        </div>

        <div class="cube-transform">
          <div class="cube-face"></div>
          <div class="cube-face"></div>
          <div class="cube-face"></div>
          <div class="cube-face"></div>
          <div class="cube-face"></div>
          <div class="cube-face"></div>
        </div>
      </div>

      <div class="corner-accent"></div>
      <div class="corner-accent"></div>
      <div class="corner-accent"></div>
      <div class="corner-accent"></div>

      <div class="holo-glow"></div>
    </label>

    <div class="status-text" id="statusText"></div>

    <div class="frequency-spectrum" aria-hidden="true">
      <!-- 20 bars -->
      <div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div>
      <div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div>
      <div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div>
      <div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div><div class="frequency-bar"></div>
    </div>

    <div class="data-chips">
      <div class="data-chip" id="chipStatus">STATUS: IDLE [0x4F]</div>
      <div class="data-chip" id="chipRange">RANGE: LAST 14D</div>
      <div class="data-chip" id="chipRows">ROWS: --</div>
      <div class="data-chip" id="chipSig">0x7A2C8B9F</div>
    </div>
  </div>

  <!-- Dashboard -->
  <main class="dashboard" id="dashboard" aria-hidden="true">
    <div class="dash-wrap">

      <header class="dash-header">
        <div class="hero">
          <div class="hero-inner">
            <div class="title-block">
              <h1>لوحة تأخيرات الرحلات • SGS</h1>
              <div class="sub">فعّل زر الهولو لبدء التحليل. يتم تحميل بيانات جدول <b>sgs_flight_delay</b> وإنشاء الرسوم والقيَم تلقائياً.</div>
            </div>

            <div class="meta-line">
              <div class="meta-pill" id="metaUpdated">آخر تحديث: —</div>
              <div class="meta-pill" id="metaMode">MODE: API</div>
              <div class="meta-pill" id="metaHint">أمان أعلى: API عبر السيرفر</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="ctrl">
            <label>من تاريخ</label>
            <input type="date" id="fromDate" />
          </div>
          <div class="ctrl">
            <label>إلى تاريخ</label>
            <input type="date" id="toDate" />
          </div>
          <div class="ctrl">
            <label>الشفت</label>
            <select id="shiftSel">
              <option value="">الكل</option>
            </select>
          </div>
          <div class="ctrl">
            <label>شركة الطيران</label>
            <select id="airlineSel">
              <option value="">الكل</option>
            </select>
          </div>

          <button class="btn" id="refreshBtn">تحديث التحليل</button>
          <button class="btn secondary" id="exportBtn" title="تصدير Top Flights إلى CSV">تصدير CSV</button>
        </div>
      </header>

      <section class="grid" style="margin-bottom: 12px;">
        <div class="card" data-i="1" style="grid-column: span 3;">
          <div class="hd"><div class="t">إجمالي السجلات</div><div class="s" id="kpiStamp">—</div></div>
          <div class="bd">
            <div class="kpi">
              <div class="m"><div class="label">حالات التأخير</div><div class="hint">عدد الصفوف ضمن الفترة المحددة</div></div>
              <div class="v" id="kpiTotal">—</div>
            </div>
          </div>
        </div>

        <div class="card" data-i="2" style="grid-column: span 3;">
          <div class="hd"><div class="t">رحلات فريدة</div><div class="s"><span class="pill" id="kpiUniqPill">—</span></div></div>
          <div class="bd">
            <div class="kpi">
              <div class="m"><div class="label">Unique Flights</div><div class="hint">Date + Flight Number</div></div>
              <div class="v" id="kpiUnique">—</div>
            </div>
          </div>
        </div>

        <div class="card" data-i="3" style="grid-column: span 3;">
          <div class="hd"><div class="t">أكثر Delay Code</div><div class="s" id="kpiCodePct">—</div></div>
          <div class="bd">
            <div class="kpi">
              <div class="m"><div class="label" id="kpiCodeLabel">—</div><div class="hint">الأكثر تكراراً ضمن الفترة</div></div>
              <div class="v" id="kpiCodeCount">—</div>
            </div>
          </div>
        </div>

        <div class="card" data-i="4" style="grid-column: span 3;">
          <div class="hd"><div class="t">أكثر شركة طيران</div><div class="s" id="kpiAirPct">—</div></div>
          <div class="bd">
            <div class="kpi">
              <div class="m"><div class="label" id="kpiAirLabel">—</div><div class="hint">الأكثر تكراراً ضمن الفترة</div></div>
              <div class="v" id="kpiAirCount">—</div>
            </div>
          </div>
        </div>
      </section>

      <section class="grid" style="margin-bottom: 12px;">
        <div class="card" data-i="5" style="grid-column: span 6;">
          <div class="hd"><div class="t">التأخيرات حسب التاريخ</div><div class="s">Trend</div></div>
          <div class="bd"><div class="chartBox tall"><canvas id="chartTrend"></canvas></div></div>
        </div>

        <div class="card" data-i="6" style="grid-column: span 6;">
          <div class="hd"><div class="t">Top Delay Codes</div><div class="s">Top 10</div></div>
          <div class="bd"><div class="chartBox"><canvas id="chartCodes"></canvas></div></div>
        </div>

        <div class="card" data-i="7" style="grid-column: span 6;">
          <div class="hd"><div class="t">Top Airlines</div><div class="s">Top 10</div></div>
          <div class="bd"><div class="chartBox"><canvas id="chartAir"></canvas></div></div>
        </div>

        <div class="card" data-i="8" style="grid-column: span 6;">
          <div class="hd"><div class="t">توزيع الشفت</div><div class="s">Shift</div></div>
          <div class="bd"><div class="chartBox"><canvas id="chartShift"></canvas></div></div>
        </div>
      </section>

      <section class="grid">
        <div class="card" data-i="9" style="grid-column: span 12;">
          <div class="hd"><div class="t">Top Flights (حسب عدد سجلات التأخير)</div><div class="s">Date + Flight Number</div></div>
          <div class="bd" style="max-height: 380px; overflow:auto;">
            <table class="table" id="topFlightsTbl">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>رقم الرحلة</th>
                  <th>شركة الطيران</th>
                  <th>الوجهة</th>
                  <th>عدد السجلات</th>
                  <th class="muted">Delay Codes</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="6" class="muted">فعّل زر الهولو لعرض البيانات.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /****************************************************************
     * ⚙️ إعداد الربط (غيّر فقط هذا الجزء)
     ****************************************************************/
    const CONFIG = {
      mode: "api", // "api" | "supabase" | "demo"
      apiBaseUrl: "", // نفس الدومين: اتركه فارغ. أو ضع: "https://your-domain.com"
      // Supabase (اختياري)
      supabaseUrl: "",
      supabaseAnonKey: "",
      // Default period
      defaultDays: 14,
      maxTop: 10
    };

    /****************************************************************
     * ✅ Contract المطلوب إذا كنت تستخدم API:
     * GET  /api/meta -> { shifts: [], airlines: [] }
     * GET  /api/summary?from=YYYY-MM-DD&to=YYYY-MM-DD&shift=&airline=
     *  -> {
     *      total_records, unique_flights,
     *      date_series:[{date,count}],
     *      top_delay_codes:[{label,count}],
     *      top_airlines:[{label,count}],
     *      shift_dist:[{label,count}],
     *      top_flights:[{date,flight,airline,dest,count,codes}]
     *     }
     ****************************************************************/

    // ===== Elements =====
    const body = document.body;
    const holoCheck = document.getElementById("holo-check");
    const statusText = document.getElementById("statusText");
    const dashboard = document.getElementById("dashboard");

    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const shiftSel = document.getElementById("shiftSel");
    const airlineSel = document.getElementById("airlineSel");

    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");

    const chipStatus = document.getElementById("chipStatus");
    const chipRange = document.getElementById("chipRange");
    const chipRows = document.getElementById("chipRows");
    const chipSig = document.getElementById("chipSig");

    const metaUpdated = document.getElementById("metaUpdated");
    const metaMode = document.getElementById("metaMode");
    const metaHint = document.getElementById("metaHint");

    const kpiStamp = document.getElementById("kpiStamp");
    const kpiTotal = document.getElementById("kpiTotal");
    const kpiUnique = document.getElementById("kpiUnique");
    const kpiUniqPill = document.getElementById("kpiUniqPill");
    const kpiCodeLabel = document.getElementById("kpiCodeLabel");
    const kpiCodeCount = document.getElementById("kpiCodeCount");
    const kpiCodePct = document.getElementById("kpiCodePct");
    const kpiAirLabel = document.getElementById("kpiAirLabel");
    const kpiAirCount = document.getElementById("kpiAirCount");
    const kpiAirPct = document.getElementById("kpiAirPct");

    const topFlightsTBody = document.getElementById("topFlightsTbl").querySelector("tbody");
    const toastEl = document.getElementById("toast");

    // Keep last top flights for export
    let lastTopFlights = [];

    // ===== Helpers =====
    const fmtInt = (n) => (n ?? 0).toLocaleString("en-US");
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2600);
    }

    function isoDate(d) {
      const x = new Date(d);
      const pad = (v) => String(v).padStart(2, "0");
      return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`;
    }

    function setDefaultDates() {
      const now = new Date();
      const to = new Date(now);
      const from = new Date(now);
      from.setDate(from.getDate() - CONFIG.defaultDays + 1);
      fromDate.value = isoDate(from);
      toDate.value = isoDate(to);
      chipRange.textContent = `RANGE: LAST ${CONFIG.defaultDays}D`;
    }

    function animateNumber(el, to, duration=650) {
      const start = Number(String(el.textContent).replace(/[^0-9.-]/g,"")) || 0;
      const end = Number(to) || 0;
      const t0 = performance.now();
      function frame(t) {
        const p = clamp((t - t0) / duration, 0, 1);
        const eased = 1 - Math.pow(1 - p, 3);
        const val = Math.round(start + (end - start) * eased);
        el.textContent = fmtInt(val);
        if (p < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function safeStr(v, fallback="—") {
      const s = (v === null || v === undefined || String(v).trim() === "") ? "" : String(v);
      return s ? s : fallback;
    }

    function pct(part, total) {
      if (!total) return "0%";
      return `${(part/total*100).toFixed(1)}%`;
    }

    // ===== Charts =====
    let trendChart, codeChart, airChart, shiftChart;

    function destroyCharts() {
      for (const c of [trendChart, codeChart, airChart, shiftChart]) {
        if (c) c.destroy();
      }
      trendChart = codeChart = airChart = shiftChart = null;
    }

    function commonChartOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "rgba(0,0,0,0.75)",
            borderColor: "rgba(255,255,255,0.18)",
            borderWidth: 1,
            titleColor: "rgba(255,255,255,0.92)",
            bodyColor: "rgba(255,255,255,0.88)",
            displayColors: false,
          }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,0.68)", font: { weight: "700" } },
            grid: { color: "rgba(255,255,255,0.06)" }
          },
          y: {
            ticks: { color: "rgba(255,255,255,0.68)", font: { weight: "700" } },
            grid: { color: "rgba(255,255,255,0.06)" }
          }
        }
      };
    }

    function makeLine(ctx, labels, data) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 2,
            tension: 0.32,
            fill: true
          }]
        },
        options: {
          ...commonChartOptions(),
          scales: {
            ...commonChartOptions().scales,
            x: { ...commonChartOptions().scales.x, ticks: { ...commonChartOptions().scales.x.ticks, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } }
          }
        }
      });
    }

    function makeBar(ctx, labels, data) {
      return new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: commonChartOptions()
      });
    }

    function makeDonut(ctx, labels, data) {
      return new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: "rgba(255,255,255,0.75)",
                boxWidth: 12,
                padding: 14,
                font: { weight: "800" }
              }
            },
            tooltip: commonChartOptions().plugins.tooltip
          }
        }
      });
    }

    // ===== Data (API / Supabase / Demo) =====
    async function loadMeta() {
      metaMode.textContent = `MODE: ${CONFIG.mode.toUpperCase()}`;
      metaHint.textContent = (CONFIG.mode === "api")
        ? "أمان أعلى: API عبر السيرفر"
        : (CONFIG.mode === "supabase")
          ? "قراءة مباشرة: Supabase (تأكد من RLS)"
          : "Demo: بيانات تجريبية";

      if (CONFIG.mode !== "api") return;

      try {
        const res = await fetch(`${CONFIG.apiBaseUrl}/api/meta`);
        if (!res.ok) return;
        const meta = await res.json();
        fillSelect(shiftSel, meta.shifts || []);
        fillSelect(airlineSel, meta.airlines || []);
      } catch {
        // silent
      }
    }

    function fillSelect(sel, arr) {
      const keepFirst = sel.querySelector("option[value='']");
      sel.innerHTML = "";
      sel.appendChild(keepFirst);
      (arr || []).filter(Boolean).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    async function fetchSummaryApi(from, to, shift, airline) {
      const params = new URLSearchParams();
      params.set("from", from);
      params.set("to", to);
      if (shift) params.set("shift", shift);
      if (airline) params.set("airline", airline);
      const res = await fetch(`${CONFIG.apiBaseUrl}/api/summary?${params.toString()}`);
      if (!res.ok) throw new Error("API error");
      return await res.json();
    }

    async function fetchRowsSupabase(from, to, shift, airline) {
      if (!window.supabase) {
        await new Promise((resolve) => {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
          s.onload = resolve;
          document.head.appendChild(s);
        });
      }
      const sb = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
      let q = sb.from("sgs_flight_delay").select('*').gte("Date", from).lte("Date", to).limit(10000);
      if (shift) q = q.eq("Shift", shift);
      if (airline) q = q.eq("Airlines", airline);
      const { data, error } = await q;
      if (error) throw error;
      return data || [];
    }

    function summarizeRows(rows) {
      const total = rows.length;

      const uniqKey = (r) => `${r["Date"] || ""}|${r["Flight Number"] || ""}`;
      const uniqFlights = new Set(rows.map(uniqKey).filter(x => x !== "|")).size;

      const countBy = (field) => {
        const m = new Map();
        for (const r of rows) {
          const k = (r[field] ?? "").toString().trim();
          if (!k) continue;
          m.set(k, (m.get(k) || 0) + 1);
        }
        return m;
      };

      const seriesByDate = () => {
        const m = new Map();
        for (const r of rows) {
          const d = (r["Date"] ?? "").toString();
          if (!d) continue;
          m.set(d, (m.get(d) || 0) + 1);
        }
        const keys = Array.from(m.keys()).sort();
        return keys.map(k => ({ date: k, count: m.get(k) }));
      };

      const mapToTop = (m, limit=CONFIG.maxTop) => {
        return Array.from(m.entries())
          .sort((a,b) => b[1]-a[1])
          .slice(0, limit)
          .map(([label,count]) => ({ label, count }));
      };

      const topCodes = mapToTop(countBy("Delay Code"));
      const topAir = mapToTop(countBy("Airlines"));
      const shiftDist = mapToTop(countBy("Shift"), 20);

      // Top flights by #records + list of codes
      const flightMap = new Map();
      for (const r of rows) {
        const d = (r["Date"] ?? "").toString();
        const fn = (r["Flight Number"] ?? "").toString().trim();
        if (!d || !fn) continue;
        const key = `${d}|${fn}`;
        const cur = flightMap.get(key) || {
          date: d,
          flight: fn,
          airline: r["Airlines"] ?? "",
          dest: r["Destination"] ?? "",
          count: 0,
          codes: new Set(),
        };
        cur.count += 1;
        const c = (r["Delay Code"] ?? "").toString().trim();
        if (c) cur.codes.add(c);
        flightMap.set(key, cur);
      }
      const topFlights = Array.from(flightMap.values())
        .sort((a,b) => b.count - a.count)
        .slice(0, 10)
        .map(x => ({ ...x, codes: Array.from(x.codes).join(", ") }));

      return {
        total_records: total,
        unique_flights: uniqFlights,
        date_series: seriesByDate(),
        top_delay_codes: topCodes,
        top_airlines: topAir,
        shift_dist: shiftDist,
        top_flights: topFlights,
      };
    }

    // ===== Render =====
    function setLoadingState() {
      metaUpdated.textContent = "آخر تحديث: جاري التحليل...";
      kpiStamp.textContent = "جاري التحميل...";
      chipRows.textContent = "ROWS: ...";
      chipStatus.textContent = "STATUS: LOADING [0xA1]";
      statusText.innerHTML = '<span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> ANALYZING...</span>';

      // reset UI numbers
      kpiTotal.textContent = "—";
      kpiUnique.textContent = "—";
      kpiUniqPill.textContent = "—";
      kpiCodeLabel.textContent = "—";
      kpiCodeCount.textContent = "—";
      kpiCodePct.textContent = "—";
      kpiAirLabel.textContent = "—";
      kpiAirCount.textContent = "—";
      kpiAirPct.textContent = "—";
    }

    function render(summary) {
      const total = summary.total_records || 0;
      const uniq = summary.unique_flights || 0;
      const topCode = (summary.top_delay_codes && summary.top_delay_codes[0]) || { label: "—", count: 0 };
      const topAir = (summary.top_airlines && summary.top_airlines[0]) || { label: "—", count: 0 };

      const stamp = new Date().toLocaleString("en-GB");
      metaUpdated.textContent = `آخر تحديث: ${stamp}`;
      kpiStamp.textContent = `تحديث: ${stamp}`;

      animateNumber(kpiTotal, total);
      animateNumber(kpiUnique, uniq);
      kpiUniqPill.textContent = `${pct(uniq, Math.max(total,1))} من السجلات`;

      kpiCodeLabel.textContent = safeStr(topCode.label);
      animateNumber(kpiCodeCount, topCode.count);
      kpiCodePct.textContent = `${pct(topCode.count, Math.max(total,1))}`;

      kpiAirLabel.textContent = safeStr(topAir.label);
      animateNumber(kpiAirCount, topAir.count);
      kpiAirPct.textContent = `${pct(topAir.count, Math.max(total,1))}`;

      chipRows.textContent = `ROWS: ${fmtInt(total)}`;
      chipStatus.textContent = "STATUS: ONLINE [0x7F]";
      statusText.textContent = "DASHBOARD ONLINE";

      // Table
      const rows = summary.top_flights || [];
      lastTopFlights = rows;
      topFlightsTBody.innerHTML = rows.length ? "" : '<tr><td colspan="6" class="muted">لا توجد بيانات ضمن الفترة.</td></tr>';

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${safeStr(r.date)}</td>
          <td>${safeStr(r.flight)}</td>
          <td>${safeStr(r.airline)}</td>
          <td>${safeStr(r.dest)}</td>
          <td>${fmtInt(r.count)}</td>
          <td class="muted">${safeStr(r.codes, "")}</td>
        `;
        topFlightsTBody.appendChild(tr);
      }

      // Charts
      destroyCharts();

      const trend = summary.date_series || [];
      const trendLabels = trend.map(x => x.date);
      const trendData = trend.map(x => x.count);

      const codes = (summary.top_delay_codes || []);
      const codeLabels = codes.map(x => x.label);
      const codeData = codes.map(x => x.count);

      const airs = (summary.top_airlines || []);
      const airLabels = airs.map(x => x.label);
      const airData = airs.map(x => x.count);

      const shifts = (summary.shift_dist || []);
      const shiftLabels = shifts.map(x => x.label);
      const shiftData = shifts.map(x => x.count);

      trendChart = makeLine(document.getElementById("chartTrend"), trendLabels, trendData);
      codeChart  = makeBar (document.getElementById("chartCodes"), codeLabels, codeData);
      airChart   = makeBar (document.getElementById("chartAir"),   airLabels,  airData);
      shiftChart = makeDonut(document.getElementById("chartShift"), shiftLabels, shiftData);

      // move view to top smoothly after first render
      setTimeout(() => {
        const firstCard = document.querySelector(".dashboard .card");
        if (firstCard) firstCard.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 220);
    }

    async function runAnalysis() {
      const from = fromDate.value;
      const to = toDate.value;
      const shift = shiftSel.value;
      const airline = airlineSel.value;

      setLoadingState();

      try {
        let summary;
        if (CONFIG.mode === "api") {
          summary = await fetchSummaryApi(from, to, shift, airline);
        } else if (CONFIG.mode === "supabase") {
          const rows = await fetchRowsSupabase(from, to, shift, airline);
          summary = summarizeRows(rows);
        } else {
          const rows = DEMO_ROWS.filter(r => r.Date >= from && r.Date <= to);
          summary = summarizeRows(rows.map(r => ({ "Date": r.Date, "Shift": r.Shift, "Airlines": r.Airlines, "Flight Number": r.Flight, "Destination": r.Dest, "Delay Code": r.Code })));
        }

        render(summary);
      } catch (e) {
        console.error(e);
        chipStatus.textContent = "STATUS: ERROR [0xE2]";
        statusText.textContent = "CONNECTION FAILED";
        chipRows.textContent = "ROWS: --";
        metaUpdated.textContent = "آخر تحديث: فشل الاتصال";
        showToast("تعذر تحميل البيانات. تأكد من /api/summary أو إعداد Supabase.");
      }
    }

    function activate() {
      body.classList.add("dash-active");
      dashboard.setAttribute("aria-hidden", "false");
      statusText.textContent = "INITIALIZING...";
      chipStatus.textContent = "STATUS: INIT [0x11]";
      chipSig.textContent = "0x" + Math.floor(Math.random()*0xffffffff).toString(16).toUpperCase().padStart(8,"0");

      setTimeout(() => {
        dashboard.scrollTo({ top: 0, behavior: "smooth" });
      }, 70);

      runAnalysis();
    }

    function deactivate() {
      body.classList.remove("dash-active");
      dashboard.setAttribute("aria-hidden", "true");
      statusText.textContent = "";
      chipStatus.textContent = "STATUS: IDLE [0x4F]";
      chipRows.textContent = "ROWS: --";
      lastTopFlights = [];
      destroyCharts();
    }

    holoCheck.addEventListener("change", () => {
      if (holoCheck.checked) activate();
      else deactivate();
    });

    refreshBtn.addEventListener("click", () => {
      if (!holoCheck.checked) return showToast("فعّل زر الهولو أولاً.");
      runAnalysis();
    });

    exportBtn.addEventListener("click", () => {
      if (!holoCheck.checked) return showToast("فعّل زر الهولو أولاً.");
      if (!lastTopFlights.length) return showToast("لا توجد بيانات لتصديرها.");
      const headers = ["date","flight","airline","dest","count","codes"];
      const lines = [headers.join(",")];
      for (const r of lastTopFlights) {
        const row = headers.map(h => {
          const v = (r[h] ?? "").toString().replaceAll('"','""');
          return `"${v}"`;
        });
        lines.push(row.join(","));
      }
      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `top_flights_${fromDate.value}_${toDate.value}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });

    // Demo dataset (only for demo mode)
    const DEMO_ROWS = [
      { Date: "2025-12-10", Shift: "A", Airlines: "SV", Flight: "SV123", Dest: "JED", Code: "15I" },
      { Date: "2025-12-10", Shift: "A", Airlines: "SV", Flight: "SV123", Dest: "JED", Code: "15I" },
      { Date: "2025-12-11", Shift: "B", Airlines: "XY", Flight: "XY222", Dest: "DMM", Code: "33A" },
      { Date: "2025-12-12", Shift: "C", Airlines: "SV", Flight: "SV887", Dest: "DXB", Code: "14A" },
      { Date: "2025-12-12", Shift: "C", Airlines: "SV", Flight: "SV887", Dest: "DXB", Code: "15F" },
      { Date: "2025-12-13", Shift: "B", Airlines: "XY", Flight: "XY333", Dest: "MED", Code: "15I" },
    ];

    // Init
    setDefaultDates();
    loadMeta();
  </script>
</body>
</html>
