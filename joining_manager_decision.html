<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>قرار المدير – طلب الانضمام</title>
  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,"Segoe UI",Arial,sans-serif}
    .wrap{max-width:720px;margin:32px auto;padding:0 14px}
    .card{background:linear-gradient(180deg,rgba(30,41,59,.9),rgba(15,23,42,.9));
      border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 10px;font-size:18px}
    p{margin:8px 0;font-size:14px;line-height:1.7}
    .small{font-size:12px;color:#9ca3af;margin-top:12px}
    #state{margin-bottom:8px}
    .ok,.err{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;background:rgba(148,163,184,.12);color:#cbd5f5}
    .ok{color:#22c55e}
    .err{color:#f97373}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>قرار مدير الإدارة بشأن طلب الانضمام</h1>
      <p id="state">جاري التحقق من الرابط…</p>
      <p id="msg">نقوم الآن بمعالجة طلبك.</p>
      <p class="small">سيتم تحديث هذه الصفحة بعد تنفيذ الإجراء.</p>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co";
    const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_ANON_KEY"; // ضع نفس المفتاح الموجود بملف قرار الغياب
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msgEl   = document.getElementById("msg");
    const stateEl = document.getElementById("state");

    function state(type, text) {
      stateEl.className = type === "ok" ? "ok" : "err";
      stateEl.textContent = text;
    }

    // نفس الآلية: نقرأ من # ثم من ?
    function getParams() {
      const url = new URL(window.location.href);
      const hashParams = new URLSearchParams((window.location.hash || "").replace(/^#/, ""));
      const action = (hashParams.get("action") || url.searchParams.get("action") || "").trim();
      const requestId  = (hashParams.get("request_id") || url.searchParams.get("request_id") || "").trim();
      return { action, requestId };
    }

    function normalizeAction(a) {
      const x = (a || "").toLowerCase().trim();
      if (["approve","ok","accept"].includes(x)) return "approve";
      if (["reject","close","deny"].includes(x)) return "reject";
      return x;
    }

    async function start() {
      const { action: rawAction, requestId } = getParams();
      const action = normalizeAction(rawAction);

      if (!action || !requestId) {
        state("err", "رابط غير صالح");
        msgEl.textContent = "تأكد أن الرابط يحتوي action و request_id.";
        return;
      }

      const { data: reqRow, error: reqErr } = await supabase
        .from("join_requests")
        .select("join_request_id, employee_id, email, status, requested_role, created_at")
        .eq("join_request_id", requestId)
        .maybeSingle();

      if (reqErr || !reqRow) {
        state("err", "تعذر تحميل طلب الانضمام.");
        return;
      }

      if (action === "approve" && reqRow.status === "approved") {
        state("ok", "تمت الموافقة مسبقًا.");
        msgEl.textContent = `الموظف: ${reqRow.employee_id} — البريد: ${reqRow.email}`;
        return;
      }
      if (action === "reject" && reqRow.status === "rejected") {
        state("ok", "تم الإغلاق/الرفض مسبقًا.");
        msgEl.textContent = `الموظف: ${reqRow.employee_id} — البريد: ${reqRow.email}`;
        return;
      }

      const newStatus = action === "approve" ? "approved" : "rejected";

      const { error: upErr } = await supabase
        .from("join_requests")
        .update({ status: newStatus, updated_at: new Date().toISOString() })
        .eq("join_request_id", requestId);

      if (upErr) {
        state("err", "تعذر تحديث حالة الطلب (تحقق من سياسات RLS للـ UPDATE).");
        return;
      }

      // إرسال البريد فورًا (بدون انتظار cron) — نفس آليتك
      try {
        await fetch("https://inuqlhkoaoeiycefvjyj.supabase.co/functions/v1/nxs-email-worker", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "process_queue" })
        });
      } catch (_) {}

      state("ok", action === "approve" ? "تم الاعتماد وإرسال التفعيل للموظف ✅" : "تم إغلاق الطلب دون اعتماد ✅");
      msgEl.textContent = `الموظف: ${reqRow.employee_id} — البريد: ${reqRow.email}`;
    }

    start().catch((e) => {
      console.error(e);
      state("err", "حدث خطأ غير متوقع أثناء تنفيذ العملية.");
    });
  </script>
</body>
</html>
