<!DOCTYPE html>
<html lang="en-GB" dir="ltr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Employee Absence</title>

<script>
(function(){
  try{
    var KEY='pref-theme', LEGACY='theme';
    function resolveSystem(){return (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'}
    function applyTheme(v){
      var t=v||localStorage.getItem(KEY)||localStorage.getItem(LEGACY)||'light';
      if(t==='system') t=resolveSystem();
      document.documentElement.setAttribute('data-theme',t);
    }
    applyTheme();
    window.addEventListener('storage',e=>{ if(e.key===KEY||e.key===LEGACY) applyTheme(e.newValue); });
  }catch(e){}
})();
</script>

<style>
/* ===== Light theme ===== */
:root{
  --page-bg-light:#F6F4F1;
  --card-bg-light:#FAFAFA;
  --card-border-light:#E8E8E8;
  --field-bg-light:#FAFAFA;
  --field-border-light:#E8E8E8;

  --text-light:#0F1220;
  --muted-light:#6B7280;

  --brand:#22D3A6;
  --accent:#6D28D9;

  --shadow:0 10px 30px rgba(2,8,23,.12);
  --radius:22px;

  --bg:var(--page-bg-light);
  --card:var(--card-bg-light);
  --ring:var(--card-border-light);
  --field-bg:var(--field-bg-light);
  --field-border:var(--field-border-light);
  --text:var(--text-light);
  --muted:var(--muted-light);
}

/* ===== Dark theme ===== */
[data-theme="dark"]{
  --page-bg-dark:#2A2A3C;
  --card-bg-dark:#323248;
  --card-border-dark:#2A2B2C;
  --field-bg-dark:#323248;
  --field-border-dark:#4C4C6C;

  --text-dark:#E5E7EB;
  --muted-dark:#94A3B8;

  --bg:var(--page-bg-dark);
  --card:var(--card-bg-dark);
  --ring:var(--card-border-dark);
  --field-bg:var(--field-bg-dark);
  --field-border:var(--field-border-dark);
  --text:var(--text-dark);
  --muted:var(--muted-dark);

  --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{min-height:100%;overflow:auto}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at 85% -10%, color-mix(in oklab, var(--brand) 20%, transparent), transparent 60%),
    radial-gradient(1000px 700px at -10% 100%, color-mix(in oklab, var(--brand) 20%, transparent), transparent 55%),
    var(--bg);
  color:var(--text);
  font:14px/1.5 "Segoe UI",Inter,Roboto,system-ui,-apple-system,sans-serif;
}
.container{max-width:1120px;margin:32px auto;padding:0 16px}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
.title{font-size:18px;font-weight:700}
.btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--ring);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;text-decoration:none;transition:transform .12s ease,filter .12s ease}

.panel{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form .full{grid-column:1/-1}
label{display:block;color:var(--muted);font-size:12px;margin:7px 0 6px}
input,select,textarea{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--field-border);outline:none;background:var(--field-bg);color:var(--text)
}
textarea{min-height:90px;resize:vertical}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.3px}
input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent)}
.toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#F9FAFB;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:9999}
.toast.ok{background:linear-gradient(135deg,#16A34A,#22D3A6)}
.toast.err{background:linear-gradient(135deg,#EF4444,#F14668)}
@media (max-width:720px){
  .form{grid-template-columns:1fr}
}

#submitBtn:hover{filter:brightness(1.05);transform:translateY(-1px)}
#submitBtn:active{transform:translateY(0)}
</style>
<script src="/auth.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">ğŸ“‹ Employee Absence</div>
    <div style="display:flex;gap:8px;">
      <a href="../Navigation panel.html" class="btn">âŸµ Back</a>
      <a href="../index.html" class="btn">Home</a>
    </div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <div>
        <div style="font-weight:700;font-size:16px">Employee Absence</div>
        <div style="color:var(--muted);font-size:12px">Absence notifications &amp; investigation.</div>
      </div>
      <div><button id="submitBtn" class="btn" style="background:var(--brand);color:#fff;border-color:transparent">Submit</button></div>
    </div>

    <form id="dynForm" class="form" novalidate>
      <div>
        <label for="f_Date">Date *</label>
        <input id="f_Date" type="text" class="mono" data-mask="date" inputmode="numeric" maxlength="10"
               placeholder="DD-MM-YYYY" pattern="^([0-2]\d|3[01])-(0\d|1[0-2])-\d{4}$" required/>
      </div>

      <div>
        <label for="f_Shift">Shift</label>
        <select id="f_Shift">
          <option>Shift A</option>
          <option>Shift B</option>
          <option>Shift C</option>
        </select>
      </div>

      <div>
        <label for="f_Department">Department</label>
        <select id="f_Department">
          <option>TCC</option>
          <option>FIC Saudia</option>
          <option>FIC Nas</option>
          <option>LC Saudia</option>
          <option>LC Foreign</option>
        </select>
      </div>

      <div>
        <label for="f_EmployeeID">Employee ID *</label>
        <input id="f_EmployeeID" type="text" required/>
      </div>

      <div class="full">
        <label for="f_Notes">Notes</label>
        <textarea id="f_Notes" placeholder="Optional notes..."></textarea>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
/* === Supabase configuration === */
const SUPABASE_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludXFsaGtvYW9laXljZWZ2anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMTUxODEsImV4cCI6MjA3ODY5MTE4MX0.DCAY9rN0noaBoE_T-6eDsb_79szK91af989f9TqjEow";

/* Helpers */
function normalizeDigits(s){
  if(!s) return s;
  const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  return String(s).replace(/[Ù -Ù©]/g,ch=>map[ch]);
}
function toDDMMYYYY(s){
  s=normalizeDigits(s)||'';
  if(/^\d{2}-\d{2}-\d{4}$/.test(s)) return s;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const y=s.slice(0,4),m=s.slice(5,7),d=s.slice(8,10);
    return `${d}-${m}-${y}`;
  }
  return s;
}
function ddmmyyyyToISO(s){
  if(!s) return '';
  s = normalizeDigits(s.trim());
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = s.match(/^([0-2]\d|3[01])-(0\d|1[0-2])-(\d{4})$/);
  if(!m) return '';
  return `${m[3]}-${m[2]}-${m[1]}`;
}
function to24h(t){
  t=normalizeDigits(t)||'';
  const m=t.match(/(\d{1,2}):(\d{2})/);
  if(!m) return '';
  let hh=Math.max(0,Math.min(23,parseInt(m[1],10)||0));
  const mm=m[2];
  return String(hh).padStart(2,'0')+':'+mm;
}
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.toggle('ok',!isErr);
  t.classList.toggle('err',isErr);
  t.style.display='block';
  setTimeout(()=>t.style.display='none',2600);
}
function attachMasks(root){
  root.querySelectorAll('input[data-mask="time"]').forEach(el=>{
    el.addEventListener('input',()=>{
      let v=normalizeDigits(el.value).replace(/[^0-9]/g,'').slice(0,4);
      if(v.length>=3) v=v.slice(0,2)+':'+v.slice(2);
      el.value=v;
    });
    el.addEventListener('blur',()=>{ if(/^(\d{1,2}):(\d{2})$/.test(el.value)) el.value=to24h(el.value); });
  });
  root.querySelectorAll('input[data-mask="date"]').forEach(el=>{
    el.addEventListener('input',()=>{
      let v=normalizeDigits(el.value).replace(/[^0-9]/g,'').slice(0,8);
      if(v.length>=5) v=v.slice(0,2)+'-'+v.slice(2,4)+'-'+v.slice(4);
      else if(v.length>=3) v=v.slice(0,2)+'-'+v.slice(2);
      el.value=v;
    });
  });
}

/* Supabase helpers */
function ensureSupabaseConfig(){
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    throw new Error("Supabase configuration is missing.");
  }
}

async function fetchEmployeeNameById(employeeId){
  ensureSupabaseConfig();
  const baseUrl = SUPABASE_URL.replace(/\/$/, "");
  const endpoint = baseUrl + "/rest/v1/employee_master_db"
    + "?Employee%20ID=eq." + encodeURIComponent(employeeId)
    + "&select=" + encodeURIComponent('"Employee Name"');

  const response = await fetch(endpoint, {
    method: "GET",
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    }
  });

  const data = await response.json().catch(() => null);

  if (!response.ok) {
    const msg = (data && (data.message || JSON.stringify(data))) || response.statusText;
    throw new Error("Failed to fetch employee name from employee_master_db: " + msg);
  }

  if (!Array.isArray(data) || data.length === 0) {
    return null; // Employee ID not found
  }

  const row = data[0];
  const empName = row && row["Employee Name"] ? row["Employee Name"] : null;
  return empName;
}

async function insertEmployeeAbsenceRecord(payload){
  ensureSupabaseConfig();
  const endpoint = SUPABASE_URL.replace(/\/\$/, "") + "/rest/v1/employee_absence";

  // âœ… ØªÙ†Ø¸ÙŠÙ Ù†Ù‡Ø§Ø¦ÙŠ ÙŠÙ…Ù†Ø¹ bigint: ""
  const clean = { ...payload };

  function fixBigIntField(fieldName){
    const v = clean[fieldName];
    const s = (v ?? "").toString().trim();

    // Ù„Ùˆ ÙØ§Ø¶ÙŠ -> Ù„Ø§ Ù†Ø±Ø³Ù„Ù‡
    if (s === "") {
      delete clean[fieldName];
      return;
    }

    // Ù„Ùˆ Ø±Ù‚Ù… ÙƒÙ†Øµ -> Ù†Ø­ÙˆÙ„Ù‡ Ø±Ù‚Ù…
    if (/^\d+$/.test(s)) {
      clean[fieldName] = Number(s);
      return;
    }

    // Ù„Ùˆ Ù…Ùˆ Ø±Ù‚Ù… -> Ù„Ø§ Ù†Ø±Ø³Ù„Ù‡
    delete clean[fieldName];
  }

  fixBigIntField("Employee ID");
  fixBigIntField("Title");

  console.log("ABSENCE_PAYLOAD_CLEAN", clean);

  const response = await fetch(endpoint,{
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Prefer": "return=representation"
    },
    body: JSON.stringify(clean)
  });

  const data = await response.json().catch(() => null);

  if (!response.ok) {
    const msg = (data && (data.message || JSON.stringify(data))) || response.statusText;
    throw new Error("Insert into Supabase failed: " + msg);
  }

  return data;
}

/* Init */
attachMasks(document);

/* Auto-fill today's date in DD-MM-YYYY (editable) */
document.addEventListener("DOMContentLoaded", () => {
  const f_Date = document.getElementById('f_Date');
  if (f_Date && !f_Date.value){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    f_Date.value = `${dd}-${mm}-${yyyy}`;
  }
});

/* Submit handler */
document.getElementById('submitBtn').addEventListener('click', async (e)=>{
  e.preventDefault();

  function toBigIntOrNull(v) {
    const s = (v ?? "").toString().trim();
    if (!s) return null;               // Ù„Ùˆ ÙØ§Ø¶ÙŠ -> null
    if (!/^\d+$/.test(s)) return null; // Ù„Ùˆ Ù…Ùˆ Ø±Ù‚Ù… -> null
    return Number(s);
  }

  const f_Date = document.getElementById('f_Date');
  const f_Shift = document.getElementById('f_Shift');
  const f_Department = document.getElementById('f_Department');
  const f_EmployeeID = document.getElementById('f_EmployeeID');
  const f_Notes = document.getElementById('f_Notes');

  let DateUI = toDDMMYYYY(f_Date.value || '');
  let EmployeeID = (normalizeDigits(f_EmployeeID.value||'')).trim();

  let ok = true;
  function mark(el, good){ el.style.borderColor = good ? 'var(--field-border)' : 'crimson'; if(!good) ok=false; }

  const dateRx = /^([0-2]\d|3[01])-(0\d|1[0-2])-(\d{4})$/;
  mark(f_Date, dateRx.test(DateUI));
  mark(f_EmployeeID, !!EmployeeID);

  if(!ok){ showToast('Please fill/format required fields (DD-MM-YYYY).', true); return; }

  const isoDate = ddmmyyyyToISO(DateUI);
  if(!isoDate){ showToast('Invalid Date: use DD-MM-YYYY (e.g. 20-09-2025)', true); return; }

  const employeeIdNum = toBigIntOrNull(EmployeeID);
  if (employeeIdNum === null) {
    showToast('Employee ID must be a valid number.', true);
    return;
  }

  try{
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØŒ Ù„ÙƒÙ† ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ Ù„Ø§ Ù†Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸
    let employeeName = null;
    try {
      employeeName = await fetchEmployeeNameById(employeeIdNum);
    } catch (e) {
      console.warn('Failed to fetch employee name, will continue without it:', e);
    }

    const titleValue = Date.now();
    const nowIso = new Date().toISOString();

    
    const payload = {
      "Title": titleValue,
      "Date": isoDate,
      "Shift": f_Shift.value || null,
      "Department": f_Department.value || null,
      "Employee ID": employeeIdNum,
      "Employee Name": employeeName,
      "Absence Notification Status": null,
      "InvestigationID": null,
      "Consent to send investigation": null,
      "Current reminder": null,
      "Respond to the investigation": null,
      "Administrative procedure": null,
      "Final action": null,
      "Investigation status": null,
      "Manager Notes": f_Notes.value || null,
      "Last Update": nowIso,
      "Item Type": null,
      "Path": null
    };

    // âœ… ØªÙ†Ø¸ÙŠÙ: Ø£ÙŠ Ù‚ÙŠÙ…Ø© "" Ù„Ù„Ø£Ø±Ù‚Ø§Ù… ØªØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ null (Ø£Ùˆ Ù†Ø­Ø°ÙÙ‡Ø§)
    function fixBigIntField(obj, fieldName) {
      const v = obj[fieldName];
      const s = (v ?? "").toString().trim();

      if (s === "") {
        // Ø§Ù„Ø£ÙØ¶Ù„: Ù„Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø­Ù‚Ù„ Ø£ØµÙ„Ø§Ù‹
        delete obj[fieldName];
        return;
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ù†ØµÙŠ Ù†Ø­ÙˆÙ„Ù‡ Ø±Ù‚Ù…
      if (/^\d+$/.test(s)) {
        obj[fieldName] = Number(s);
        return;
      }

      // Ø¥Ø°Ø§ Ù…Ùˆ Ø±Ù‚Ù…: Ù„Ø§ Ù†Ø±Ø³Ù„Ù‡
      delete obj[fieldName];
    }

    // âœ… Ø·Ø¨Ù‘Ù‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
    fixBigIntField(payload, "Employee ID");
    fixBigIntField(payload, "Title");

    // âœ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    

      await insertEmployeeAbsenceRecord(payload);
    showToast('Saved successfully âœ“', false);
    document.getElementById('dynForm').reset();

    // Re-fill today's date after reset
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    f_Date.value = `${dd}-${mm}-${yyyy}`;

  }catch(e){
    showToast('Error: '+(e.message||'Failed'), true);
    console.error('Submission error:', e);
  }
});

document.addEventListener('DOMContentLoaded',function(){
  var el=document.getElementById('f_Date');
  if(el && !el.value){
    var d=new Date();
    var dd=String(d.getDate()).padStart(2,'0');
    var mm=String(d.getMonth()+1).padStart(2,'0');
    var yyyy=d.getFullYear();
    el.value=dd+'-'+mm+'-'+yyyy;
    el.readOnly=true;
  }
});

</script>
</body>
</html>
