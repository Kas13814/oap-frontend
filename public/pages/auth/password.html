<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>OAP - Activate account & set password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #F0EFE8;
      display: grid;
      place-items: center;
      padding: 16px;
      color: #fff;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== Card (same style family as Join/Login) ===== */
    .login-box {
      position: relative;
      width: 400px;
      padding: 62px 40px 40px 40px; /* keeps OAP tag separate; content slightly lower */
      background: rgba(0,0,0,.9);
      box-sizing: border-box;
      box-shadow: 0 15px 25px rgba(0,0,0,.6);
      border-radius: 10px;
    }

    /* OAP badge (top-left) */
    .oap-tag{
      position: absolute;
      top: 14px;
      left: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.95);
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      user-select: none;
      pointer-events: none;
    }

    .title {
      text-align: center;
      margin-bottom: 18px;
    }
    .title-main {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 0 0 6px;
      color: #fff;
    }
    .title-sub {
      font-size: 13px;
      color: #aaa;
      margin: 0;
      line-height: 1.6;
    }

    /* ===== Floating label inputs (RTL-friendly labels) ===== */
    .user-box { position: relative; }
    .user-box input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      color: #fff;
      margin-bottom: 26px;
      border: none;
      border-bottom: 1px solid #fff;
      outline: none;
      background: transparent;
      direction: ltr;
      text-align: left;
    }

    /* Error underline when required field is empty */
    .user-box input.input-error{
      border-bottom-color: #ff0000 !important;
    }
    .user-box input[type="password"]{
      letter-spacing: 0.12em;
    }
    .user-box label {
      position: absolute;
      top: 0;
      left: 0;
      right: auto;
      padding: 10px 0;
      font-size: 14px;
      color: #fff;
      pointer-events: none;
      transition: .5s;
      text-align: left;
      width: 100%;
    }
    .user-box input:focus ~ label,
    .user-box input:valid ~ label {
      top: -20px;
      left: 0;
      color: #fff;
      font-size: 12px;
    }

    /* Autofill fix */
    .user-box input:-webkit-autofill,
    .user-box input:-webkit-autofill:hover,
    .user-box input:-webkit-autofill:focus,
    .user-box input:-webkit-autofill:active{
      -webkit-text-fill-color: #fff;
      caret-color: #fff;
      transition: background-color 9999s ease-in-out 0s;
      box-shadow: 0 0 0 1000px rgba(0,0,0,.9) inset;
      border-bottom: 1px solid #fff;
    }

    /* ===== Steps ===== */
    .step { display: none; animation: fadeIn 0.18s ease-out; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    /* ===== Animated primary button ===== */
    .btn-submit {
      position: relative;
      display: inline-block;
      width: 100%;
      padding: 10px 20px;
      font-weight: 700;
      color: #fff;
      font-size: 14px;
      text-decoration: none;
      text-transform: uppercase;
      overflow: hidden;
      transition: .5s;
      letter-spacing: 2px;
      background: transparent;
      border: 0;
      cursor: pointer;
      margin-top: 6px;
    }
    .btn-submit:hover {
      background: #fff;
      color: #272727;
      border-radius: 5px;
    }
    .btn-submit span { position: absolute; display: block; }
    .btn-submit span:nth-child(1) {
      top: 0; left: -100%; width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, #fff);
      animation: btn-anim1 1.5s linear infinite;
    }
    @keyframes btn-anim1 { 0% { left: -100%; } 50%,100% { left: 100%; } }
    .btn-submit span:nth-child(2) {
      top: -100%; right: 0; width: 2px; height: 100%;
      background: linear-gradient(180deg, transparent, #fff);
      animation: btn-anim2 1.5s linear infinite;
      animation-delay: .375s;
    }
    @keyframes btn-anim2 { 0% { top: -100%; } 50%,100% { top: 100%; } }
    .btn-submit span:nth-child(3) {
      bottom: 0; right: -100%; width: 100%; height: 2px;
      background: linear-gradient(270deg, transparent, #fff);
      animation: btn-anim3 1.5s linear infinite;
      animation-delay: .75s;
    }
    @keyframes btn-anim3 { 0% { right: -100%; } 50%,100% { right: 100%; } }
    .btn-submit span:nth-child(4) {
      bottom: -100%; left: 0; width: 2px; height: 100%;
      background: linear-gradient(360deg, transparent, #fff);
      animation: btn-anim4 1.5s linear infinite;
      animation-delay: 1.125s;
    }
    @keyframes btn-anim4 { 0% { bottom: -100%; } 50%,100% { bottom: 100%; } }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #aaa;
      line-height: 1.7;
    }

    .message {
      margin-top: 14px;
      font-size: 13px;
      border-radius: 10px;
      padding: 10px 12px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .message.ok {
      background: rgba(34, 197, 94, 0.10);
      border: 1px solid rgba(34, 197, 94, 0.60);
      color: #bbf7d0;
    }
    .message.err {
      background: rgba(239, 68, 68, 0.10);
      border: 1px solid rgba(248, 113, 113, 0.80);
      color: #fecaca;
    }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      line-height: 1.6;
    }

    @media (max-width: 480px){
      body{ padding: 14px; }
      .login-box{ width: 100%; }
    }

  </style>
</head>
<body>

  <div class="login-box">
    <div class="oap-tag">OAP</div>

    <div class="title">
      <div class="title-main">Activate account &amp; set password</div>
      <p class="title-sub">Account activation</p>
    </div>

    <!-- الخطوة 1: إدخال الرقم الوظيفي -->
    <div id="step-id" class="step active">
      <div class="user-box">
        <input id="employeeId" type="text" required />
        <label for="employeeId">Employee ID</label>
      </div>

      <button id="btnSendCode" class="btn-submit" type="button">
        <span></span><span></span><span></span><span></span>
        Send verification code
      </button>

      <div class="hint">
        A verification code will be sent — please check your email.
      </div>
    </div>

    <!-- الخطوة 2: إدخال الكود -->
    <div id="step-code" class="step">
      <div class="user-box">
        <input id="verifyCode" type="text" maxlength="6" required />
        <label for="verifyCode">Verification code</label>
      </div>

      <button id="btnVerifyCode" class="btn-submit" type="button">
        <span></span><span></span><span></span><span></span>
        Verify code
      </button>

      <div class="hint">
        Check your email for the verification code.<br/>
        If you didn’t receive it, go back and resend the code.
      </div>
    </div>

    <!-- الخطوة 3: Set password -->
    <div id="step-password" class="step">
      <div class="user-box">
        <input id="newPassword" type="password" required minlength="8" />
        <label for="newPassword">New password</label>
      </div>

      <div class="user-box" style="margin-top: 4px;">
        <input id="confirmPassword" type="password" required minlength="8" />
        <label for="confirmPassword">Confirm password</label>
      </div>

      <button id="btnSetPassword" class="btn-submit" type="button">
        <span></span><span></span><span></span><span></span>
        Set password
      </button>

      <div class="hint">
        Set a strong password and confirm it to finish activation.
      </div>
    </div>

    <div id="msg" class="message" style="display:none;"></div>

    <div class="footer">
      OAP • System<br />
      This page works internally.
    </div>
  </div>


  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
// بيانات Supabase
    const SUPABASE_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludXFsaGtvYW9laXljZWZ2anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMTUxODEsImV4cCI6MjA3ODY5MTE4MX0.DCAY9rN0noaBoE_T-6eDsb_79szK91af989f9TqjEow";

    // ✅ رابط Edge Function الصحيح
    const WORKER_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co/functions/v1/nxs-email-worker";

    // ✅ جدول الإرسال (Outbox) — سنضيف بريد كود التحقق هنا ثم نطلب من worker إرسال الـ queue
    const OUTBOX_URL = SUPABASE_URL + "/rest/v1/oap_email_outbox";

    const stepId = document.getElementById("step-id");
    const stepCode = document.getElementById("step-code");
    const stepPassword = document.getElementById("step-password");

    const employeeInput = document.getElementById("employeeId");
    const verifyInput = document.getElementById("verifyCode");
    const newPasswordInput = document.getElementById("newPassword");
    const confirmPasswordInput = document.getElementById("confirmPassword");

    const btnSendCode = document.getElementById("btnSendCode");
    const btnVerifyCode = document.getElementById("btnVerifyCode");
    const btnSetPassword = document.getElementById("btnSetPassword");

    const msgBox = document.getElementById("msg");

    // ==== Inline field validation (underline becomes red when empty) ====
    function setInputError(input, isError) {
      if (!input) return;
      if (isError) input.classList.add("input-error");
      else input.classList.remove("input-error");
    }

    // Remove red underline as soon as the user starts typing
    [employeeInput, verifyInput, newPasswordInput, confirmPasswordInput].forEach((el) => {
      if (!el) return;
      el.addEventListener("input", () => setInputError(el, false));
    });


    // قراءة الرقم الوظيفي من رابط الصفحة (إن وُجد)
    (function prefillEmployeeIdFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const qEmployeeId = params.get("employee_id") || params.get("employeeId");
        if (qEmployeeId) {
          employeeInput.value = qEmployeeId;
        }
      } catch (e) {
        console.warn("Cannot read employee_id from URL", e);
      }
    })();

    let currentEmployeeId = null;
    let generatedCode = null;
    let resetToken = null;

    function showMessage(text, type) {
      msgBox.textContent = text;
      msgBox.className = "message " + (type === "ok" ? "ok" : "err");
      msgBox.style.display = "block";
    }

    function setStep(step) {
      stepId.classList.remove("active");
      stepCode.classList.remove("active");
      stepPassword.classList.remove("active");

      if (step === "id") stepId.classList.add("active");
      if (step === "code") stepCode.classList.add("active");
      if (step === "password") stepPassword.classList.add("active");
    }

    // هاش SHA-256 بسيط لكلمة المرور
    async function sha256Hex(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const bytes = new Uint8Array(digest);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function buildResetEmailHtml(employeeId, code) {
      const email = `${employeeId}@saudiags.com`;
      return `
<div style="margin:0;padding:0;background:#0b0b0b">
  <div style="max-width:880px;margin:0 auto;padding:22px">
    <div style="background:linear-gradient(180deg,#1a1a1a,#111111);
                border:1px solid rgba(255,255,255,.08);
                border-radius:22px;
                padding:18px 18px 16px;
                box-shadow:0 18px 35px rgba(0,0,0,.55);">
      <div style="display:flex;justify-content:flex-end;margin-bottom:10px">
        <div style="background:#f3f4f6;color:#111827;border-radius:999px;padding:6px 12px;
                    font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:700;">
          OAP - كود التحقق
        </div>
      </div>

      <div style="text-align:center;color:#ffffff;font-family:Arial,Helvetica,sans-serif;
                  font-size:22px;font-weight:800;margin:0 0 10px 0;">
        تفعيل الحساب
      </div>

      <div style="text-align:center;color:rgba(255,255,255,.80);
                  font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:1.8;margin:0 0 14px 0;">
        هذا هو رمز التحقق الخاص بك لإكمال تفعيل الحساب.
      </div>

      <div style="background:rgba(255,255,255,.06);
                  border:1px solid rgba(255,255,255,.10);
                  border-radius:16px;padding:14px 16px;margin:0 0 16px 0;">
        <div style="text-align:right;color:#ffffff;font-family:Arial,Helvetica,sans-serif;
                    font-size:14px;line-height:1.9;font-weight:700;">
          رقم الموظف: ${employeeId}<br/>
          البريد: ${email}<br/>
        </div>
        <div style="text-align:center;margin-top:12px;">
          <div style="display:inline-block;background:rgba(255,255,255,.06);
                      border:1px dashed rgba(255,255,255,.28);
                      border-radius:14px;padding:14px 18px;
                      font-family:Arial,Helvetica,sans-serif;font-size:26px;font-weight:900;
                      letter-spacing:6px;color:#ffffff;">
            ${code}
          </div>
        </div>
      </div>

      <div style="text-align:center;color:rgba(255,255,255,.55);
                  font-family:Arial,Helvetica,sans-serif;font-size:12px;margin-top:8px;">
        هذه رسالة تلقائية صادرة من نظام OAP — يرجى عدم مشاركة رمز التحقق مع أي شخص.
      </div>
    </div>
  </div>
</div>`;
    }

    async function enqueueEmailToOutbox({ to, subject, type, html, preview }) {
      const payload = {
        to,
        subject,
        type,
        role: "system",
        body_html: html,
        body_preview: preview || null,
        attempt_count: 0
      };

      const res = await fetch(OUTBOX_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY,
          Prefer: "return=minimal"
        },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (!res.ok) {
        throw new Error(`Outbox insert failed. status=${res.status} response=${text}`);
      }
      return true;
    }

    async function processQueueNow() {
      const actions = ["process_queue", "processQueue", "process-queue"];
      let lastErr = null;

      for (const a of actions) {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: a })
        });

        const text = await res.text();
        if (res.ok) return true;

        // لو رجع invalid_action نجرب اسم action ثاني
        if (text && text.toLowerCase().includes("invalid_action")) {
          lastErr = new Error(`Worker invalid_action for action=${a}. response=${text}`);
          continue;
        }

        throw new Error(`Worker failed. status=${res.status} response=${text}`);
      }

      throw lastErr || new Error("Worker failed with invalid_action");
    }

    // الخطوة 1: Send verification code
    btnSendCode.addEventListener("click", async () => {
      msgBox.style.display = "none";
      const employeeId = employeeInput.value.trim();
      if (!employeeId) {
        setInputError(employeeInput, true);
        showMessage("يرجى إدخال الرقم الوظيفي أولاً.", "err");
        return;
      }
      setInputError(employeeInput, false);

      const code = String(Math.floor(1000 + Math.random() * 9000));
      generatedCode = code;
      const emailTo = `${employeeId}@saudiags.com`;

      btnSendCode.disabled = true;
      btnSendCode.textContent = "جاري الإرسال...";

      try {
        const html = buildResetEmailHtml(employeeId, code);
        const preview = `رمز التحقق لتفعيل حساب OAP هو: ${code}`;

        // ⚠️ ملاحظة: تأكد أن worker يسمح بالـ type = password_reset
        await enqueueEmailToOutbox({
          to: emailTo,
          subject: "OAP - رمز التحقق",
          type: "password_reset",
          html,
          preview
        });

        await processQueueNow();

        currentEmployeeId = employeeId;
        verifyInput.value = "";
        setStep("code");
        showMessage("تم إرسال رمز التحقق إلى بريدك الوظيفي. الرجاء إدخال الرمز.", "ok");
      } catch (err) {
        console.error(err);
        showMessage("حدث خطأ في الاتصال. حاول مرة أخرى.\n" + (err?.message || err), "err");
      } finally {
        btnSendCode.disabled = false;
        btnSendCode.textContent = "Send verification code";
      }
    });

    // الخطوة 2: التحقق من الرمز
    btnVerifyCode.addEventListener("click", () => {
      msgBox.style.display = "none";
      const code = verifyInput.value.trim();

      if (!currentEmployeeId || !generatedCode) {
        showMessage("انتهت الجلسة أو لم يتم إرسال رمز بعد. يرجى إدخال الرقم الوظيفي وإعادة إرسال الرمز.", "err");
        setStep("id");
        return;
      }

      if (!code) {
        setInputError(verifyInput, true);
        showMessage("يرجى إدخال رمز التحقق.", "err");
        return;
      }
      setInputError(verifyInput, false);

      if (code !== generatedCode) {
        showMessage("الرمز غير صحيح. تأكد من إدخاله كما هو في البريد.", "err");
        return;
      }

      resetToken = code;
      setStep("password");
      showMessage("تم التحقق من الرمز بنجاح. يمكنك الآن Set password.", "ok");
    });

    // الخطوة 3: Set password
    btnSetPassword.addEventListener("click", async () => {
      msgBox.style.display = "none";

      const pass1 = newPasswordInput.value;
      const pass2 = confirmPasswordInput.value;

      if (!currentEmployeeId || !resetToken) {
        showMessage("انتهت الجلسة. يرجى البدء من جديد.", "err");
        setStep("id");
        return;
      }

      if (!pass1 || pass1.length < 8) {
        setInputError(newPasswordInput, true);
        showMessage("يجب أن تكون كلمة المرور ٨ أحرف على الأقل.", "err");
        return;
      }
      setInputError(newPasswordInput, false);

      if (!pass2) {
        setInputError(confirmPasswordInput, true);
        showMessage("يرجى تأكيد كلمة المرور.", "err");
        return;
      }
      setInputError(confirmPasswordInput, false);

      if (pass1 !== pass2) {
        setInputError(confirmPasswordInput, true);
        showMessage("كلمتا المرور غير متطابقتين.", "err");
        return;
      }
      setInputError(confirmPasswordInput, false);

      btnSetPassword.disabled = true;
      btnSetPassword.textContent = "جاري الحفظ...";

      try {
        const employeeIdNum = Number(currentEmployeeId);
        const email = `${currentEmployeeId}@saudiags.com`;

        // ✅ RPC لتفادي RLS عند قراءة join_requests
        const rpcRes = await fetch(SUPABASE_URL + "/rest/v1/rpc/oap_get_join_tenant_id", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ p_employee_id: employeeIdNum })
        });

        const rpcText = await rpcRes.text();
        let tenantId = null;
        try { tenantId = JSON.parse(rpcText); } catch (_) {}

        if (!rpcRes.ok || tenantId == null) {
          showMessage("تعذر قراءة tenant_id من join_requests.\nstatus: " + rpcRes.status + "\nresponse: " + rpcText, "err");
          btnSetPassword.disabled = false;
          btnSetPassword.textContent = "Set password";
          return;
        }

        const passwordHash = await sha256Hex(pass1);

        const res = await fetch(SUPABASE_URL + "/rest/v1/users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY,
            Prefer: "return=representation",
          },
          body: JSON.stringify({
            tenant_id: tenantId,
            employee_id: employeeIdNum,
            username: currentEmployeeId,
            email: email,
            role: "staff",
            is_active: true,
            password_hash: passwordHash
          }),
        });

        const text = await res.text();

        if (!res.ok) {
          showMessage("تعذر حفظ حساب المستخدم في Supabase.\nstatus: " + res.status + "\nresponse: " + text, "err");
        } else {
          showMessage("تم Set password وحفظ بيانات حسابك بنجاح.", "ok");
          btnSetPassword.disabled = true;
        }
      } catch (err) {
        console.error(err);
        showMessage("حدث خطأ أثناء حفظ كلمة المرور.\n" + (err?.message || err), "err");
      } finally {
        if (!btnSetPassword.disabled) {
          btnSetPassword.textContent = "Set password";
        }
      }
    });
});
  </script>

</body>
</html>
