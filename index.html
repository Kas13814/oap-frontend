-- 1) عرض قائمة الصلاحيات (Admin فقط)
create or replace function public.admin_list_permissions()
returns table (
  employee_id bigint,
  email text,
  settings boolean,
  ai boolean,
  dashboard boolean
)
language sql
stable
security definer
set search_path = public
as $$
  select
    u.user_id as employee_id,
    au.email,
    coalesce(bool_or(upp.page_key='settings'  and upp.can_access), false) as settings,
    coalesce(bool_or(upp.page_key='ai'        and upp.can_access), false) as ai,
    coalesce(bool_or(upp.page_key='dashboard' and upp.can_access), false) as dashboard
  from public.users u
  join auth.users au on au.id = u.auth_user_id
  left join public.user_page_permissions upp on upp.user_id = au.id
  where public.is_admin() = true
  group by u.user_id, au.email
  order by u.user_id;
$$;

-- 2) جلب صلاحيات موظف واحد (Admin فقط)
create or replace function public.admin_get_permissions_by_employee(p_employee_id bigint)
returns json
language sql
stable
security definer
set search_path = public
as $$
  select json_build_object(
    'settings',  coalesce(bool_or(upp.page_key='settings'  and upp.can_access), false),
    'ai',        coalesce(bool_or(upp.page_key='ai'        and upp.can_access), false),
    'dashboard', coalesce(bool_or(upp.page_key='dashboard' and upp.can_access), false)
  )
  from public.users u
  join auth.users au on au.id = u.auth_user_id
  left join public.user_page_permissions upp on upp.user_id = au.id
  where public.is_admin() = true
    and u.user_id = p_employee_id;
$$;

-- 3) إلغاء/حذف كل صلاحيات موظف (Admin فقط)
create or replace function public.admin_revoke_all_by_employee(p_employee_id bigint)
returns void
language plpgsql
security definer
set search_path = public
as $$
declare
  v_uid uuid;
begin
  if not public.is_admin() then
    raise exception 'not authorized';
  end if;

  select u.auth_user_id into v_uid
  from public.users u
  where u.user_id = p_employee_id
  limit 1;

  if v_uid is null then
    raise exception 'user not found';
  end if;

  delete from public.user_page_permissions
  where user_id = v_uid;
end;
$$;

grant execute on function public.admin_list_permissions() to authenticated;
grant execute on function public.admin_get_permissions_by_employee(bigint) to authenticated;
grant execute on function public.admin_revoke_all_by_employee(bigint) to authenticated;
