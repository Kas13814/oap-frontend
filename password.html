<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>NXS - تفعيل الحساب وتعيين كلمة المرور</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .card {
      width: 100%;
      max-width: 440px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      padding: 24px 22px 20px;
    }
    .title {
      text-align: center;
      margin-bottom: 18px;
    }
    .title-main {
      font-size: 26px;
      font-weight: 700;
      color: #38bdf8;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .title-sub {
      font-size: 13px;
      color: #9ca3af;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }
    input {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      direction: ltr;
      text-align: left;
    }
    input[type="password"] {
      direction: ltr;
      text-align: left;
      letter-spacing: 0.12em;
    }
    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.2);
    }
    button {
      width: 100%;
      margin-top: 14px;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.35);
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(56, 189, 248, 0.45);
    }
    .hint {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.7;
    }
    .message {
      margin-top: 12px;
      font-size: 13px;
      border-radius: 10px;
      padding: 9px 10px;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .message.ok {
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
    }
    .message.err {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }
    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }
    .step {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }
    .step.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">
      <div class="title-main">NXS – OAP</div>
      <div class="title-sub">تفعيل الحساب وتعيين كلمة المرور</div>
    </div>

    <!-- الخطوة 1: إدخال الرقم الوظيفي -->
    <div id="step-id" class="step active">
      <label for="employeeId">الرقم الوظيفي (بدون @saudiags.com)</label>
      <input id="employeeId" type="text" placeholder="مثال: 15013814" />

      <button id="btnSendCode">إرسال رمز التحقق</button>

      <div class="hint">
        سيتم إرسال رمز مكوّن من ٤ أرقام إلى بريدك الوظيفي
        (<span style="direction:ltr;unicode-bidi:bidi-override;">employee@saudiags.com</span>).
      </div>
    </div>

    <!-- الخطوة 2: إدخال الكود -->
    <div id="step-code" class="step">
      <label for="verifyCode">رمز التحقق المرسل إلى بريدك</label>
      <input id="verifyCode" type="text" maxlength="6" placeholder="أدخل الرمز هنا" />

      <button id="btnVerifyCode">تأكيد الرمز</button>

      <div class="hint">
        تحقق من بريدك الوظيفي وابحث عن رسالة تحتوي على رمز التحقق.<br/>
        إذا لم تصلك رسالة خلال دقائق، يمكنك الرجوع خطوة للخلف وإعادة الإرسال.
      </div>
    </div>

    <!-- الخطوة 3: تعيين كلمة المرور -->
    <div id="step-password" class="step">
      <label for="newPassword">كلمة المرور الجديدة</label>
      <input id="newPassword" type="password" placeholder="٨ أحرف على الأقل" />

      <label for="confirmPassword" style="margin-top:10px;">تأكيد كلمة المرور</label>
      <input id="confirmPassword" type="password" placeholder="أعد إدخال كلمة المرور" />

      <button id="btnSetPassword">تعيين كلمة المرور</button>

      <div class="hint">
        سيتم كذلك حفظ بيانات حسابك في جدول users على Supabase بعد تعيين كلمة المرور.
      </div>
    </div>

    <div id="msg" class="message" style="display:none;"></div>

    <div class="footer">
      OAP • وحدة المراقبة والتحكم التشغيلي (TCC)<br />
      هذه الصفحة تعمل داخليًا فقط.
    </div>
  </div>

  <script>
    // بيانات Supabase
    const SUPABASE_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludXFsaGtvYW9laXljZWZ2anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMTUxODEsImV4cCI6MjA3ODY5MTE4MX0.DCAY9rN0noaBoE_T-6eDsb_79szK91af989f9TqjEow";
    const FUNCTION_URL = "https://inuqlhkoaoeiycefvjyj.functions.supabase.co/nxs-email-worker";
    const NXS_SECRET = ""; // لو عندك NXS_EMAIL_SECRET في الـ Function ضع نفس القيمة هنا

    const stepId = document.getElementById("step-id");
    const stepCode = document.getElementById("step-code");
    const stepPassword = document.getElementById("step-password");

    const employeeInput = document.getElementById("employeeId");
    const verifyInput = document.getElementById("verifyCode");
    const newPasswordInput = document.getElementById("newPassword");
    const confirmPasswordInput = document.getElementById("confirmPassword");

    const btnSendCode = document.getElementById("btnSendCode");
    const btnVerifyCode = document.getElementById("btnVerifyCode");
    const btnSetPassword = document.getElementById("btnSetPassword");

    const msgBox = document.getElementById("msg");

    // قراءة الرقم الوظيفي من رابط الصفحة (إن وُجد)
    (function prefillEmployeeIdFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const qEmployeeId = params.get("employee_id") || params.get("employeeId");
        if (qEmployeeId) {
          employeeInput.value = qEmployeeId;
        }
      } catch (e) {
        console.warn("Cannot read employee_id from URL", e);
      }
    })();

    let currentEmployeeId = null;
    let generatedCode = null;
    let resetToken = null;

    function showMessage(text, type) {
      msgBox.textContent = text;
      msgBox.className = "message " + (type === "ok" ? "ok" : "err");
      msgBox.style.display = "block";
    }

    function setStep(step) {
      stepId.classList.remove("active");
      stepCode.classList.remove("active");
      stepPassword.classList.remove("active");

      if (step === "id") stepId.classList.add("active");
      if (step === "code") stepCode.classList.add("active");
      if (step === "password") stepPassword.classList.add("active");
    }

    // هاش SHA-256 بسيط لكلمة المرور
    async function sha256Hex(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const bytes = new Uint8Array(digest);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // الخطوة 1: إرسال رمز التحقق
    btnSendCode.addEventListener("click", async () => {
      msgBox.style.display = "none";
      const employeeId = employeeInput.value.trim();
      if (!employeeId) {
        showMessage("يرجى إدخال الرقم الوظيفي أولاً.", "err");
        return;
      }

      const code = String(Math.floor(1000 + Math.random() * 9000));
      generatedCode = code;
      const emailTo = `${employeeId}@saudiags.com`;

      btnSendCode.disabled = true;
      btnSendCode.textContent = "جاري الإرسال...";

      try {
        const res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            action: "reset_password",
            employee_login: employeeId,
            email_to: emailTo,
            code: code,
            ...(NXS_SECRET ? { secret: NXS_SECRET } : {}),
          }),
        });

        const text = await res.text();
        let data = {};
        try { data = JSON.parse(text); } catch (_) {}

        console.log("reset_password response:", res.status, text);

        if (!res.ok || !data.ok) {
          showMessage(
            "تعذر إرسال الرمز.\nstatus: " + res.status + "\nresponse: " + text,
            "err"
          );
        } else {
          currentEmployeeId = employeeId;
          verifyInput.value = "";
          setStep("code");
          showMessage("تم إرسال رمز التحقق إلى بريدك الوظيفي. الرجاء إدخال الرمز.", "ok");
        }
      } catch (err) {
        console.error(err);
        showMessage("حدث خطأ في الاتصال. حاول مرة أخرى.\n" + err.message, "err");
      } finally {
        btnSendCode.disabled = false;
        btnSendCode.textContent = "إرسال رمز التحقق";
      }
    });

    // الخطوة 2: التحقق من الرمز
    btnVerifyCode.addEventListener("click", () => {
      msgBox.style.display = "none";
      const code = verifyInput.value.trim();

      if (!currentEmployeeId || !generatedCode) {
        showMessage("انتهت الجلسة أو لم يتم إرسال رمز بعد. يرجى إدخال الرقم الوظيفي وإعادة إرسال الرمز.", "err");
        setStep("id");
        return;
      }

      if (!code) {
        showMessage("يرجى إدخال رمز التحقق.", "err");
        return;
      }

      if (code !== generatedCode) {
        showMessage("الرمز غير صحيح. تأكد من إدخاله كما هو في البريد.", "err");
        return;
      }

      resetToken = code;
      setStep("password");
      showMessage("تم التحقق من الرمز بنجاح. يمكنك الآن تعيين كلمة المرور.", "ok");
    });

    // الخطوة 3: تعيين كلمة المرور + جلب tenant_id من join_requests + إدراج في users
    btnSetPassword.addEventListener("click", async () => {
      msgBox.style.display = "none";

      const pass1 = newPasswordInput.value;
      const pass2 = confirmPasswordInput.value;

      if (!currentEmployeeId || !resetToken) {
        showMessage("انتهت الجلسة. يرجى البدء من جديد.", "err");
        setStep("id");
        return;
      }

      if (!pass1 || pass1.length < 8) {
        showMessage("يجب أن تكون كلمة المرور ٨ أحرف على الأقل.", "err");
        return;
      }
      if (pass1 !== pass2) {
        showMessage("كلمتا المرور غير متطابقتين.", "err");
        return;
      }

      btnSetPassword.disabled = true;
      btnSetPassword.textContent = "جاري الحفظ...";

      try {
        const employeeIdNum = Number(currentEmployeeId);
        const email = `${currentEmployeeId}@saudiags.com`;

        // 1) قراءة tenant_id من آخر join_requests approved لنفس الموظف
        const jrUrl =
          SUPABASE_URL +
          `/rest/v1/join_requests?select=tenant_id&employee_id=eq.${employeeIdNum}&status=eq.approved&order=created_at.desc&limit=1`;

        const jrRes = await fetch(jrUrl, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY,
          },
        });

        const jrText = await jrRes.text();
        let jrData = [];
        try { jrData = JSON.parse(jrText); } catch (_) {}

        console.log("join_requests lookup:", jrRes.status, jrText);

        if (!jrRes.ok) {
          showMessage(
            "تعذر قراءة بيانات الانضمام من join_requests.\nstatus: " +
              jrRes.status +
              "\nresponse: " +
              jrText,
            "err"
          );
          btnSetPassword.disabled = false;
          btnSetPassword.textContent = "تعيين كلمة المرور";
          return;
        }

        if (!Array.isArray(jrData) || jrData.length === 0 || jrData[0].tenant_id == null) {
          showMessage(
            "لم يتم العثور على طلب انضمام (join_requests) بحالة approved لهذا الموظف للحصول على tenant_id.",
            "err"
          );
          btnSetPassword.disabled = false;
          btnSetPassword.textContent = "تعيين كلمة المرور";
          return;
        }

        const tenantId = jrData[0].tenant_id;

        // 2) حساب هاش لكلمة المرور
        const passwordHash = await sha256Hex(pass1);

        // 3) إدراج في جدول users مع tenant_id
        const res = await fetch(SUPABASE_URL + "/rest/v1/users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY,
            Prefer: "return=representation",
          },
          body: JSON.stringify({
            tenant_id: tenantId,
            employee_id: employeeIdNum,
            username: currentEmployeeId,
            email: email,
            role: "staff",
            is_active: true,
            password_hash: passwordHash
          }),
        });

        const text = await res.text();
        console.log("insert users response:", res.status, text);

        if (!res.ok) {
          showMessage(
            "تعذر حفظ حساب المستخدم في Supabase.\nstatus: " + res.status + "\nresponse: " + text,
            "err"
          );
        } else {
          showMessage("تم تعيين كلمة المرور وحفظ بيانات حسابك بنجاح.", "ok");
          btnSetPassword.disabled = true;
        }
      } catch (err) {
        console.error(err);
        showMessage("حدث خطأ أثناء حفظ كلمة المرور.\n" + err.message, "err");
      } finally {
        if (!btnSetPassword.disabled) {
          btnSetPassword.textContent = "تعيين كلمة المرور";
        }
      }
    });
  </script>
</body>
</html>
