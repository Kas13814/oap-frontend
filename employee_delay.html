<!DOCTYPE html>
<html lang="en-GB" dir="ltr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Employee Delay</title>

<script>
(function(){
  try{
    var KEY='pref-theme', LEGACY='theme';
    function resolveSystem(){return (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'}
    function applyTheme(v){
      var t=v||localStorage.getItem(KEY)||localStorage.getItem(LEGACY)||'light';
      if(t==='system') t=resolveSystem();
      document.documentElement.setAttribute('data-theme',t);
    }
    applyTheme();
    window.addEventListener('storage', function(e) {
      if(e.key===KEY || e.key===LEGACY) applyTheme(e.newValue);
    });
  }catch(e){}
})();
</script>

<style>
:root{
  --page-bg-light:#F6F4F1;
  --card-bg-light:#FAFAFA;
  --card-border-light:#E8E8E8;
  --field-bg-light:#FFFFFF;
  --field-border-light:#E8E8E8;

  --text-light:#0F1220;
  --muted-light:#6B7280;

  --brand:#22D3A6;
  --accent:#6D28D9;

  --shadow:0 10px 30px rgba(2,8,23,.12);
  --radius:22px;

  --bg:var(--page-bg-light);
  --card:var(--card-bg-light);
  --ring:var(--card-border-light);
  --field-bg:var(--field-bg-light);
  --field-border:var(--field-border-light);
  --text:var(--text-light);
  --muted:var(--muted-light);
}

[data-theme="dark"]{
  --bg:#0B0B0C;
  --card:#111213;
  --ring:#2A2B2C;
  --field-bg:#0F1011;
  --field-border:#2A2B2C;
  --text:#E5E7EB;
  --muted:#94A3B8;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at 85% -10%, rgba(34,211,166,.20), transparent 60%),
    radial-gradient(1000px 700px at -10% 100%, rgba(34,211,166,.20), transparent 55%),
    var(--bg);
  color:var(--text);
  font:14px/1.5 "Segoe UI",Inter,Roboto,system-ui,-apple-system,sans-serif;
}
.container{max-width:1120px;margin:32px auto;padding:0 16px}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
.title{font-size:18px;font-weight:700}
.btn{
  display:inline-flex;gap:8px;align-items:center;
  border:1px solid var(--ring);
  background:var(--card); color:var(--text);
  padding:10px 14px; border-radius:12px;
  cursor:pointer; text-decoration:none;
}
.panel{
  background:var(--card);
  border:1px solid var(--ring);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:18px;
}
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form .full{grid-column:1/-1}
label{display:block;color:var(--muted);font-size:12px;margin:7px 0 6px}
input,select,textarea{
  width:100%; padding:10px 12px; border-radius:12px;
  border:1px solid var(--field-border); outline:none;
  background:var(--field-bg); color:var(--text);
}
textarea{min-height:90px; resize:vertical}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.3px}
input:focus, select:focus, textarea:focus{
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(34,211,166,.25);
}

#submitBtn:hover{filter:brightness(1.05);transform:translateY(-1px)}
#submitBtn:active{transform:translateY(0)}

.toast{
  position:fixed; left:16px; bottom:16px;
  background:#111827; color:#F9FAFB;
  padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); display:none;
  max-width:min(520px, calc(100vw - 32px));
  word-break:break-word;
}
.toast.ok{background:linear-gradient(135deg,#16A34A,#22D3A6)}
.toast.err{background:linear-gradient(135deg,#EF4444,#F14668)}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="title">⏱️ Employee Delay</div>
    <div style="display:flex;gap:8px;">
      <a href="../Navigation panel.html" class="btn">⟵ Back</a>
      <a href="../index.html" class="btn">Home</a>
    </div>
  </div>

  <div class="panel">
    <div class="toolbar">
      <div>
        <div style="font-weight:700;font-size:16px">Employee Delay</div>
        <div style="color:var(--muted);font-size:12px">Delay notifications &amp; investigation.</div>
      </div>
      <div><button id="submitBtn" class="btn" style="background:var(--brand);color:#fff;border-color:transparent">Submit</button></div>
    </div>

    <form id="dynForm" class="form" novalidate>
      <div>
        <label for="f_Date">Date</label>
        <input id="f_Date" type="text" class="mono" readonly/>
      </div>

      <div>
        <label for="f_Shift">Shift</label>
        <select id="f_Shift">
          <option>Shift A</option>
          <option>Shift B</option>
          <option>Shift C</option>
        </select>
      </div>

      <div>
        <label for="f_Department">Department</label>
        <select id="f_Department">
          <option>TCC</option>
          <option>FIC Saudia</option>
          <option>FIC Nas</option>
          <option>LC Saudia</option>
          <option>LC Foreign</option>
        </select>
      </div>

      <div>
        <label for="f_EmployeeID">Employee ID *</label>
        <input id="f_EmployeeID" type="text" required/>
      </div>

      <div>
        <label for="f_DelayMinutes">Delay Minutes</label>
        <input id="f_DelayMinutes" type="text"/>
      </div>

      <div class="full">
        <label for="f_Reason">Reason for Delay</label>
        <textarea id="f_Reason"></textarea>
      </div>

      <div>
        <label for="f_DelayStatus">Delay Notification Status</label>
        <input id="f_DelayStatus" type="text"/>
      </div>

      <div class="full">
        <label for="f_ManagerNotes">Manager Notes</label>
        <textarea id="f_ManagerNotes"></textarea>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
/* === Supabase configuration === */
const SUPABASE_URL = "https://inuqlhkoaoeiycefvjyj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludXFsaGtvYW9laXljZWZ2anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMTUxODEsImV4cCI6MjA3ODY5MTE4MX0.DCAY9rN0noaBoE_T-6eDsb_79szK91af989f9TqjEow";

/* Helpers */
function normalizeDigits(s){
  if(!s) return s;
  const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
  return String(s).replace(/[٠-٩]/g,ch=>map[ch]);
}

function showToast(msg, isErr){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.toggle('ok', !isErr);
  t.classList.toggle('err', !!isErr);
  t.style.display='block';
  clearTimeout(showToast._timer);
  showToast._timer=setTimeout(()=>t.style.display='none', 2800);
}

function ensureSupabaseConfig(){
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    throw new Error('Missing SUPABASE_URL or SUPABASE_ANON_KEY.');
  }
}

/* Get today in Asia/Riyadh (display dd mmmm yyyy, and ISO yyyy-mm-dd) */
function getRiyadhToday(){
  const now = new Date();
  let iso = null, display = null;

  try {
    // ISO parts
    const p = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Riyadh',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(now);

    const get = (type)=> (p.find(x=>x.type===type)||{}).value;
    const dd = get('day');
    const mm = get('month');
    const yyyy = get('year');
    iso = `${yyyy}-${mm}-${dd}`;

    const longDisp = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Asia/Riyadh',
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    }).format(now);

    // Ensure it is "dd mmmm yyyy"
    display = longDisp.replace(/\s+/g,' ').trim();
  } catch(e) {
    // Fallback (browser without timeZone support)
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const yyyy = d.getFullYear();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const mmmm = monthNames[d.getMonth()];
    display = `${dd} ${mmmm} ${yyyy}`;
    const mm = String(d.getMonth()+1).padStart(2,'0');
    iso = `${yyyy}-${mm}-${dd}`;
  }
  return { iso, display };
}

async function fetchEmployeeNameById(employeeIdNum){
  ensureSupabaseConfig();
  const endpoint = SUPABASE_URL.replace(/\/$/, "") + "/rest/v1/employee_master_db"
    + "?select=" + encodeURIComponent("Employee Name")
    + "&" + encodeURIComponent("Employee ID") + "=eq." + encodeURIComponent(employeeIdNum);

  const response = await fetch(endpoint,{
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    }
  });

  if(!response.ok) return null;
  const rows = await response.json().catch(()=>null);
  return (rows && rows[0] && rows[0]["Employee Name"]) ? rows[0]["Employee Name"] : null;
}

async function insertEmployeeDelayRecord(payload){
  ensureSupabaseConfig();
  const endpoint = SUPABASE_URL.replace(/\/$/, "") + "/rest/v1/employee_delay";

  const clean = { ...payload };

  function fixBigIntField(fieldName){
    const v = clean[fieldName];
    const s = (v ?? "").toString().trim();

    if (s === "") {
      delete clean[fieldName];
      return;
    }

    if (/^\d+$/.test(s)) {
      clean[fieldName] = Number(s);
      return;
    }

    delete clean[fieldName];
  }

  // bigint columns
  fixBigIntField("Title");
  fixBigIntField("Employee ID");

  const response = await fetch(endpoint,{
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Prefer": "return=representation"
    },
    body: JSON.stringify(clean)
  });

  const data = await response.json().catch(() => null);

  if(!response.ok){
    const msg = (data && (data.message || data.hint || data.details)) ? (data.message || data.hint || data.details) : ('HTTP ' + response.status);
    throw new Error(msg);
  }
  return data;
}

function genTitle(){
  // Use millisecond timestamp (bigint-safe)
  return Date.now();
}

document.getElementById('submitBtn').addEventListener('click', async (e)=>{
  e.preventDefault();

  const f_Date = document.getElementById('f_Date');
  const f_Shift = document.getElementById('f_Shift');
  const f_Department = document.getElementById('f_Department');
  const f_EmployeeID = document.getElementById('f_EmployeeID');
  const f_DelayMinutes = document.getElementById('f_DelayMinutes');
  const f_Reason = document.getElementById('f_Reason');
  const f_DelayStatus = document.getElementById('f_DelayStatus');
  const f_ManagerNotes = document.getElementById('f_ManagerNotes');

  let EmployeeID = (normalizeDigits(f_EmployeeID.value||'')).trim();

  let ok = true;
  function mark(el, good){ el.style.borderColor = good ? 'var(--field-border)' : 'crimson'; if(!good) ok=false; }

  mark(f_EmployeeID, !!EmployeeID);
  if(!ok){ showToast('Please fill required fields.', true); return; }

  // Employee ID must be numeric bigint
  if(!/^\d+$/.test(EmployeeID)){
    showToast('Employee ID must be a valid number.', true);
    return;
  }
  const employeeIdNum = Number(EmployeeID);

  // Date: auto-today in Riyadh (display + ISO)
  const today = getRiyadhToday();
  const isoDate = today.iso;

  try{
    let employeeName = null;
    try {
      employeeName = await fetchEmployeeNameById(employeeIdNum);
    } catch(e) {}

    const titleValue = genTitle();
    const nowIso = new Date().toISOString();

    const payload = {
      "Title": titleValue,
      "Date": isoDate,
      "Shift": (f_Shift.value || null),
      "Department": (f_Department.value || null),
      "Employee ID": employeeIdNum,
      "Employee Name": (employeeName || null),

      "Delay Minutes": (normalizeDigits(f_DelayMinutes.value||'').trim() || null),
      "Reason for Delay": (f_Reason.value || null),
      "Delay Notification Status": (f_DelayStatus.value || null),

      "InvestigationID": null,
      "Consent to send investigation": null,
      "Current reminder": null,
      "Respond to the investigation": null,
      "Administrative procedure": null,
      "Final action": null,
      "Investigation status": null,

      "Manager Notes": (f_ManagerNotes.value || null),
      "Last Update": nowIso,
      "Item Type": null,
      "Path": null
    };

    // Remove empty strings (just in case)
    Object.keys(payload).forEach(k=>{ if(payload[k]==="") payload[k]=null; });

    await insertEmployeeDelayRecord(payload);

    showToast('Saved ✓', false);
    document.getElementById('dynForm').reset();

    // re-apply auto date after reset
    const t2 = getRiyadhToday();
    f_Date.value = t2.display;
    f_Date.dataset.iso = t2.iso;
    f_Date.readOnly = true;

  }catch(e){
    showToast('Error: '+(e.message||'Failed'), true);
    console.error('Submission error:', e);
  }
});

document.addEventListener('DOMContentLoaded',function(){
  var el=document.getElementById('f_Date');
  if(el){
    var t = getRiyadhToday();
    el.value = t.display;   // dd mmmm yyyy
    el.dataset.iso = t.iso; // yyyy-mm-dd
    el.readOnly=true;
  }
});
</script>
</body>
</html>
